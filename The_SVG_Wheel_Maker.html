<!DOCTYPE html>
<meta charset="utf-8"/>



<!--============================================================================
The SVG Wheel Maker
v.beta.22


Copyright © 2017 https://github.com/Self-Evident

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
=============================================================================-->



<title>The Wheel Maker &amp; Spoke Length Calculator</title>


<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
XXXXX-body { margin: 1rem; }
/*** The prefix "WH_" simple means "WHeel" ***/

input.WH:focus, select.WH:focus, button.WH:focus { box-shadow: 0 0 3pt 1pt #006060 }
input[readonly].WH { color: #555; background-color: #bbb; border: solid .5px #999; padding: 1px 0 1px 0 }
select.WH { padding-left: .3rem; width: 3.5rem; font-size: .9rem}
select.WH option { padding-left: .5rem }


/* Removes that annoying dotted onfocus outline of FF selects */
select.WH:-moz-focusring {
	color: transparent;
	text-shadow: 0 0 0 #000;
}

#WH_CONTAINER {
	border: solid 0px red;	 /*//#####*/
	XXXXX-width : 900px;	 /*//#####*/ 
	margin: auto;
	text-align: center;
	padding: 1rem; 0 0 0;
	visibility: hidden;		/* opacity & visibility changed at end of onload. */
	opacity: 0;
	transition: opacity .5s;
}

#WH_LACE_OPT { margin: 0 0 .5rem 0; }
#WH_The_SVG   { display: inline-block; border: solid 0px red; } /*//#####*/
#WH_left_side { display: inline-block; vertical-align: top; position: relative; border: solid 0px red; } /*//#####*/

.WH_settings 		{
	border: solid 0px #333;
	border-collapse: separate;
	font-family: arial;
	width: 12rem;
	text-align: center;
}

table.WH_settings { display: inline-table; border-radius: 8px; background-color: #ccc }

.WH_settings td { padding: 2px 0 2px 0; border: solid 0px red; } /*//#####*/
.WH_settings th { height: 2.2rem; font-size: 1.1rem; border-bottom: solid 2px #333}

.WH_settings .WH_thv { text-align: left; padding: 0 0 0 3px; width: 3.2rem; font-weight: bold; }
.WH_settings input   { width: 3.5rem; text-align: center; font: 1rem courier; }
.WH_settings hr 	 { margin: .1rem 3px .5rem 3px }

.WH_separator		 { padding: 0; height: .5rem; }

.WH_settings .WH_color { width: 6rem; }

.WH_load_clear { width: 8.5rem;}

#WH_WHEEL_TYPE	 { margin: .3rem 0 .5rem 1rem; width: 6rem }


.WH_do_buttons {
	display: block;
	width: 100%;
	height: 2rem;
	margin: .3rem 0 .3rem 0;
	padding: 3px 1rem; ;
	text-align: center;
	font: normal 1.2rem arial;
	border: solid 1px #999;
	border-radius: 8px;
	background-color: #ccc;
	background: linear-gradient(to bottom, #CCC, #EEE, #CCC);
}

.WH_do_buttons:focus {
	border-color: #555;
	background: linear-gradient(to bottom, #CCC, #FFF, #FFF, #CCC);
}

.WH_do_buttons:hover {
	border-color: #555;
	background: linear-gradient(to bottom, #bbb, #FFF, #bbb);
}

.WH_do_buttons:active {
	padding: 3px 2px 1px 2px;
	background: linear-gradient(to bottom, #EEE, #CCC, #EEE);
}

.WH_do_buttons::-moz-focus-inner { border: 0 }

#WH_reset_options {
	height: 1.5rem;
	width: 60%;
	margin: 1rem auto .3rem auto;
	font-size: 1rem;
	padding: 0;
}

#WH_display_options_container { display: inline-block; border: solid 0px red; } /*//#####*/
#WH_display_options  { display: none; vertical-align: top; border: solid 0px red; } /*//#####*/
#WH_settings span.WH_th1 { text-decoration: underline; }

#WH_rim	 { fill: none; stroke: #999; }
.WH_svg	 { border: solid 0px gray; display: inline-block; margin: auto; }
.WH_axis { stroke: #999; stroke-width: 1; stroke-dasharray: 3,3; }
.WH_rsh	 { fill: none; stroke: #777; } /*rim spoke holes*/
.WH_hsh	 { fill: none; stroke: #777; } /*hub spoke holes*/
.WH_hsh2 { fill: none; stroke: #ccc; } /*hub spoke holes 2*/
.WH_spoke{ fill: none; stroke: #000; stroke-width: 2; }
.WH_pcd	 { fill: none; stroke: #000; stroke-width: 1; }

.WH_notes { font-siZe: .8rem }
.WH_th1	  { height: 1.8rem; text-decoration: underline; font-weight: bold; }
.WH_th2	  { height: 1.8rem; text-decoration: underline; }
.WH_settings td span#WH_th3	{ text-decoration: none; }

.WH_SL input { width: 4rem; text-align: center; font-size: 1rem; font-weight: bold; }


#WH_MSG_BOX {
	width	: 13rem;
	position: absolute;
	top		: 2rem;
	left	: 11rem;
	border	: solid 2px red;
	border-radius	: 5px;
	padding-top		: 1.8rem; 
	background-color: white;
	font-family		: arial;
	text-align		: center;
	visibility		: hidden;
}


#WH_CLOSE_MSG {
	width	: 2.75rem;
	position: absolute;
	top		: 0rem;
	left	: 10.0rem;
}


#WH_legend  {
	border: solid 1px black;
	border-collapse: collapse;
	font-family: arial;
	text-align: left;
	border-radius: 10px; 
}

#WH_legend td { padding: .2rem .2rem .2rem .5rem; border: solid 1px #555; }
#WH_legend th { padding: .2rem .5rem .2rem .2rem; border: solid 1px #555; }
#WH_legend th.WH_th1 { font-size: 1.2rem; text-decoration: none; }
#WH_legend th.WH { width: 7rem; }

#WH_CONSOLE { 
	float: right;
	vertical-align:top;
	display: none; 
	font-family: Courier New; 
	font-size: .8em; 
	border: solid 1px red;
	max-height: 40rem ;
	max-width: 14rem; 
	overflow-y: scroll;
	word-break: break-all;
	padding: 0 .5em;
}
</style>






<div id=WH_CONTAINER><!--====================================================-->
<div id=WH_left_side><!--==========================================-->

<div id=WH_MSG_BOX><button id=WH_CLOSE_MSG>Close</button><div id=WH_MESSAGE></div><br></div>

<table class=WH_settings>
<tr><th colspan=2>Wheel Settings</th></tr>

<tr><td colspan=2><button type=button id=WH_load_samples   class="WH WH_load_clear">Load Sample Values</button></td></tr>
<tr><td colspan=2><button type=button id=WH_clear_settings class="WH WH_load_clear">Clear Values</button></td></tr>

<tr>
	<td class=WH_thv colspan=2>Type:
		<select id=WH_WHEEL_TYPE class=WH>
			<option value=0>Standard</option>
			<option value=1>Triplet</option>
			<option value=2>Custom</option>
		</select>
		<br>
	</td>
</tr>

<tr><td class=WH_thv>ERD:</td><td><input id=WH_ERD class=WH type=text maxlength=6></td></tr>
<tr><td class=WH_thv>Rim Holes:</td><td><input id=WH_NR class=WH type=text maxlength=2></td></tr>

<tr><td></td><td>Side 1 &nbsp;Side 2</td></tr>

<tr>
	<td class=WH_thv>Flange Holes:</td>
	<td>
		<input id=WH_NF1 class=WH type=text maxlength=2 readonly tabindex=-1>
		<input id=WH_NF2 class=WH type=text maxlength=2 readonly tabindex=-1>
	</td>
</tr>
<tr>
	<td class=WH_thv>PCD:</td>
	<td>
		<input id=WH_PCD1 class=WH type=text maxlength=5>
		<input id=WH_PCD2 class=WH type=text maxlength=5>
	</td>
</tr>
<tr>
	<td class=WH_thv>FtC:</td>
	<td>
		<input id=WH_FTC1 class=WH type=text maxlength=5>
		<input id=WH_FTC2 class=WH type=text maxlength=5>
	</td>
</tr>
<tr>
	<td class=WH_thv>OSB:</td>
	<td>
		<input id=WH_OSB1 class=WH type=text maxlength=4>
		<input id=WH_OSB2 class=WH type=text maxlength=4>
	</td>
</tr>
<tr>
	<td class=WH_thv>Cross:</td>
	<td>
		<select id=WH_SX1 class=WH>
			<option value=0>0</option>
			<option value=1>1</option>
			<option value=2>2</option>
			<option value=3>3</option>
			<option value=4>4</option>
			<option value=5>5</option>
			<option value=6>6</option>
			<option value=7>7</option>
			<option value=8>8</option>
		</select>
		<select id=WH_SX2 class=WH>
			<option value=0>0</option>
			<option value=1>1</option>
			<option value=2>2</option>
			<option value=3>3</option>
			<option value=4>4</option>
			<option value=5>5</option>
			<option value=6>6</option>
			<option value=7>7</option>
			<option value=8>8</option>
		</select>
	</td>
</tr>
<tr>
	<td class=WH_thv>SHD:</td>
	<td><input id=WH_SHD class=WH type=text maxlength=4></td>
</tr>
<tr><td colspan=2 class=WH_notes>(SHD affects spoke length calculations only.)<br><br></td></tr>
<tr>
	<td class=WH_thv colspan=2>&nbsp; Lace Option:
		<select id=WH_LACE_OPT class=WH>
			<option value= 1>1&nbsp;</option>
			<option value=-1>2&nbsp;</option>
		</select>
	</td>
</tr>
</table><!--//end Wheel Settings -->
<br>
<br>


<table class=WH_settings>
<tr><th>Spoke Lengths</th></tr>
<tr><td class=WH_SL>Side 1: <input id=WH_LENGTH1 type=text readonly tabindex="-1"></td></tr>
<!-- tr><td class=WH_SL>Side 1: <input id=WH_LENGTH2 type=text readonly tabindex="-1"></td></tr -->

<tr><td class=WH_SL>Side 2: <input id=WH_LENGTH3 type=text readonly tabindex="-1"></td></tr>
<!-- tr><td class=WH_SL>Side 2: <input id=WH_LENGTH4 type=text readonly tabindex="-1"></td></tr -->
</table>
<br>

</div><!--//end WH_left_side ======================================-->








<div id=WH_The_SVG>
<!--==========
	Consider all raw size & x/y values to coorespond directly 
	to rim, hub, & spoke measurements (mm).
==========-->
<svg id="WH_box" class="WH_svg">
	<title>Wheel</title>
	<g id="WH_axes">
		<line id="WH_x-axis" class="WH_axis"/>
		<line id="WH_y-axis" class="WH_axis"/>
	</g>

	<g id="WH_wheel">
		<circle id="WH_rim"	r=""/>
		<circle id="WH_flange1" class="WH_pcd" r=""/>
		<circle id="WH_flange2" class="WH_pcd" r=""/>
		
		
		<g id=WH_Holes_and_Spokes>
			<g id="WH_rim_holes"></g>
			<g id="WH_holes_f1"></g>
			<g id="WH_holes_f2"></g>
			<g id="WH_spokes"></g>
		</g>
	</g><!-- end id=WH_wheel -->
</svg>


<br>



<div id=WH_display_options_container>
<button type=button id=WH_show_hide_DO class="WH WH_do_buttons" value=none>Display Options</button>


<div id=WH_display_options>
<table class=WH_settings>
<tr><th colspan=3>Spokes</th></tr>

<tr class=WH_th1><td>Group</td><td>Color</td><td>Show?</td></tr>

<tr class=WH_th2><td colspan=3>Side 1</td></tr>

<tr>
	<td>1</td>
	<td><input id=WH_COLOR1 class="WH WH_color" type=text></td>
	<td><input id=WH_SHOW1  class=WH type=checkbox></td>
</tr>

<tr>
	<td>2</td>
	<td><input id=WH_COLOR2 class="WH WH_color" type=text></td>
	<td><input id=WH_SHOW2  class=WH type=checkbox></td>
</tr>

<tr class=WH_separator><td colspan=3></td></tr>
<tr class=WH_th2><td colspan=3>Side 2</td></tr>

<tr>
	<td>3</td>
	<td><input id=WH_COLOR3 class="WH WH_color" type=text></td>
	<td><input id=WH_SHOW3  class=WH type=checkbox></td>
</tr>

<tr>
	<td>4</td>
	<td><input id=WH_COLOR4 class="WH WH_color" type=text></td>
	<td><input id=WH_SHOW4  class=WH type=checkbox></td>
</tr>

<tr class=WH_separator><td colspan=3></td></tr>
<tr><td colspan=3>Line Size: <input id=WH_SD class=WH type=text></td></tr>
</table>


<table id=WH_rfa_options class=WH_settings>
<tr><th colspan=4>Rim, Flange &amp; Axes</th></tr>
<tr class=WH_th1><td>Line:</td><td>Color</td><td>Size</td><td>Show?</td></tr>
<tr>
	<td>Rim</td>
	<td><input id=WH_COLOR_R class="WH WH_color" type=text></td>
	<td><input id=WH_LINE_SIZE_R  class=WH type=text></td>
	<td><input id=WH_SHOW_R  class=WH type=checkbox></td>
</tr>
<tr>
	<td>F1</td>
	<td><input id=WH_COLOR_F1 class="WH WH_color" type=text></td>
	<td><input id=WH_LINE_SIZE_F1  class=WH type=text></td>
	<td><input id=WH_SHOW_F1  class=WH type=checkbox></td>
</tr>
<tr>
	<td>F2</td>
	<td><input id=WH_COLOR_F2 class="WH WH_color" type=text></td>
	<td><input id=WH_LINE_SIZE_F2  class=WH type=text></td>
	<td><input id=WH_SHOW_F2  class=WH type=checkbox></td>
</tr>
<tr>
	<td>Holes</td>
	<td><input id=WH_HOLE_COLOR class="WH WH_color" type=text></td>
	<td><input id=WH_HOLE_LINE_SIZE class=WH type=text></td>
	<td><input id=WH_SHOW_HOLES class=WH type=checkbox></td>
</tr>
<tr><td colspan=4>Hole Diameter: <input id=WH_HOLESIZE class=WH type=text></td></tr>

<tr><td colspan=4 class=WH_notes>(Affects displayed size only.)</td></tr>
<tr class=WH_separator><td colspan=4></td></tr>
<tr>
	<td>Axes</td>
	<td><input id=WH_COLOR_AXES class="WH WH_color" type=text></td>
	<td><input id=WH_LINE_SIZE_AXES  class=WH type=text></td>
	<td><input id=WH_SHOW_AXES  class=WH type=checkbox></td>
</tr>
</table>

<button type=button id=WH_reset_options class="WH WH_do_buttons">Reset to Default Display Options</button>


</div><!--end Display Options-->
</div><!--end Display Options container-->
</div><!--end WH_The_SVG  (Originally this only contained the <svg>.)-->



<div id=WH_CONSOLE></div><br><!-- //##### #####-->



<br>
<table id=WH_legend>
<tr><th colspan=2 class=WH_th1>Notes</th></tr>
<tr><th class=WH>Rim Holes</th><td>Number of spoke holes in the Rim. Most of the time, this will be the same as the number of spokes.</td></tr>
<tr><th class=WH>Flange Holes</th><td>Number of effective spoke holes in the Flange.  That is, if you are skipping every other hole, and only using 8 out of 16, only enter 8 here.<br>
Normally, the number of holes in each hub flange, N<sub>F</sub>, is 1/2 of the holes in the rim/spoke count. One notable exception is the triplet.</td></tr>
<tr><th class=WH>PCD</th><td>"Pitch Circle Diameter" - diameter of circle running thru the spoke holes in the flange.</td></tr>
<tr><th class=WH>FtC</th><td>"Flange to Center" distance.  Used in final spoke length calculation only - does't effect display.</td></tr>
<tr><th class=WH>OSB</th><td>"Offset Spoke "Bed".  May also be referred to as "OC", "off-center", "asymetrical", or similar terms.
	<p>Useage: Enter a negative number for the side that the holes are closer to (spokes will be a tiny bit shorter); and enter a positive number for the side that the holes are further from (spoke will be a tiny bit longer). As with FtC, it does not affect displayed wheel.</td></tr>
<tr><th class=WH>Cross</th><td>"Spoke Cross" value.  Number of spokes each spoke crosses on the same side of wheel.</td></tr>
<tr><th class=WH>SHD</th><td>"Spoke Hole Diameter". Like FtC &amp; OSB, this value only affects final spoke length, but not the wheel as displayed.</td></tr>
<tr><th class=WH>Lace Option</th><td>This is mostly for triplet wheels, but can affect any non-standard lace pattern.  Just try it & see.</td>
</table>

</div><!--//end WH_CONTAINER ================================================-->








<script>(function(){
/******************************************************************************/
var D = document;
function E(id) { return document.getElementById(id); }

var NS_ = "WH_"; //"Namespace" prefix. Must coorespond with what is used for <element> id's & classes.

var LS_WHEEL_SETTINGS  = NS_ + 'wheel_settings';  //Name of wheel settings saved to localStorage.
var LS_DISPLAY_OPTIONS = NS_ + 'display_options'; //Name of display settings saved to localStorage.

var PRIOR_FOCUS = "ERD"; //Used to return focus to input that had error. Set in onfocus() events.
var PRIOR_VALUE = ""; //Used to revert to prior good value on error.


var NOTICE_MESSEGE = "<b><u>Notice!</u></b><br> This is a simple utility, and can not determine the validity of every possible combination of rim and hub measurements. <p>That is, just because this program many generate a theoretical wheel on screen from a given set of inputs, does not guarantee that such a wheel is realistically practical or possible. Or even that all required spokes lengths are listed. <p>For additional information, refer to geometry and physics.";




//id & class prefixes, etc...
var SPOKE_ID_PREFIX 	= NS_ + "spoke_";
var HUB_HOLE_ID_PREFIX	= NS_ + "f";	//Hub/flange hole id ex: WH_f1_sh1
var HUB_HOLE_MESOFIX	= "_sh";	//HUB_HOLE_ID_PREFIX + 1 + HUB_HOLE_MESOFIX + 1
var RIM_HOLE_ID_PREFIX	= NS_ + "rsh"; //WH_rsh1, WH_rsh2, etc...
var RIM_HOLE_CLASS		= NS_ + "rsh";
var SPOKE_GROUP_PREFIX	= NS_ + "group"; //WH_group1, ..., WH_group4
var SPOKE_BASE_CLASS	= NS_ + "spoke";
var HUB_HOLE_CLASS		= NS_ + "hsh";
var AXIS_CLASS			= NS_ + "axis";
var SPOKE_HOLES			= NS_ + "spoke_holes";




//Assign all element references here.
var CONTAINER = E(NS_ + 'CONTAINER');

var LOAD_SAMPLES = E(NS_ + 'load_samples');

var CLEAR_SETTINGS = E(NS_ + 'clear_settings');

var WHEEL_TYPE = E(NS_ + 'WHEEL_TYPE');

var ERD  = E(NS_ + 'ERD');	// Effective Rim Diameter
var NR   = E(NS_ + 'NR');		// Number of holes in the Rim
var NF	 = [];
	NF[1]= E(NS_ + 'NF1');	// Number of holes in Flange 1
	NF[2]= E(NS_ + 'NF2');	//    "		   "		"	 2

var MAX = {};
	MAX[NR.id] = 66;  //At these values, it starts to takes to long to run.
	MAX[NF[1].id] = 66;
	MAX[NF[2].id] = 66;

var PCD  = [];
	PCD[1] = E(NS_ + 'PCD1');	// Pitch Circle Diameter 1
	PCD[2] = E(NS_ + 'PCD2');	// 	 "	   "		"	 2
var FTC  = [];
	FTC[1] = E(NS_ + 'FTC1');	// Flange-to-Center 1 distance
	FTC[2] = E(NS_ + 'FTC2');	// 	  "			"	2	 "
var OSB  = [];
	OSB[1] = E(NS_ + 'OSB1');	// Offset Spoke Bed 1 (off center rim)
	OSB[2] = E(NS_ + 'OSB2');	// 	  "			"	2	 "		"
var SX   = [];
	SX[1]= E(NS_ + 'SX1');	// Spoke Crossing side 1
	SX[2]= E(NS_ + 'SX2');	// Spoke Crossing side 2
var SHD  = E(NS_ + 'SHD');	// Spoke Hole Diameter. Affects spoke length calcs only.
var LACE_OPT   = E(NS_ + 'LACE_OPT');// Wheel Type/Lacing Option
var LACE_OPT   = E(NS_ + 'LACE_OPT');// Wheel Type/Lacing Option
	LACE_OPT.options[0].value =  1; //The option values (1 or -1) are used in the 
	LACE_OPT.options[1].value = -1; // spoke length calculations. DO NOT CHANGE 

var SL	 = [];				//Spoke Lengths
	SL[1]= E(NS_ + 'LENGTH1');	//Flange 1 Group 1 (ie: leading/trailing...)
	SL[3]= E(NS_ + 'LENGTH3');	//		 2		 3
	//##### SL[2]= E(NS_ + 'LENGTH2');	//	  	 1		 2 //##### For future use.
	//##### SL[4]= E(NS_ + 'LENGTH4');	//		 2		 4 //##### For future use.

var DISPLAY_OPTIONS = E(NS_ + 'display_options'); //<div> around display options to enable show/hide

var SHOW_HIDE_DO  = E(NS_ + 'show_hide_DO');  //<button> to show/hide display options.
var RESET_OPTIONS = E(NS_ + 'reset_options'); //<button> to reset display options.

var SHOW = [];
	SHOW[1] = E(NS_ + 'SHOW1');// Show spoke group 1  These are mostly for trouble shooting.
	SHOW[2] = E(NS_ + 'SHOW2');// Show spoke group 2			  "				"
	SHOW[3] = E(NS_ + 'SHOW3');// Show spoke group 3			  "				"
	SHOW[4] = E(NS_ + 'SHOW4');// Show spoke group 4			  "				"
var SD      = E(NS_ + 'SD');	// Spoke Line Size / Spoke Diameter. Affects displayed spokes only.

var COLOR = [];
	COLOR[1] = E(NS_ + 'COLOR1');//Spoke group 1 color
	COLOR[2] = E(NS_ + 'COLOR2');//Spoke group 2 color
	COLOR[3] = E(NS_ + 'COLOR3');//Spoke group 3 color
	COLOR[4] = E(NS_ + 'COLOR4');//Spoke group 4 color

var RIM		= E(NS_ + 'rim'); //<circle>
var FLANGE1	= E(NS_ + 'flange1'); //<circle>
var FLANGE2	= E(NS_ + 'flange2'); //<circle>

var COLOR_R  = E(NS_ + 'COLOR_R'); //
var COLOR_F1 = E(NS_ + 'COLOR_F1');//
var COLOR_F2 = E(NS_ + 'COLOR_F2');//

var LINE_SIZE_R  = E(NS_ + 'LINE_SIZE_R');//Line widths of the rim & flange circles.
var LINE_SIZE_F1 = E(NS_ + 'LINE_SIZE_F1');
var LINE_SIZE_F2 = E(NS_ + 'LINE_SIZE_F2');

var SHOW_R  = E(NS_ + 'SHOW_R');	// Show Rim circle.
var SHOW_F1 = E(NS_ + 'SHOW_F1');	// Show Flange 1 circle.
var SHOW_F2 = E(NS_ + 'SHOW_F2');	// Show Flange 2 circle.

var HOLESIZE	   = E(NS_ + 'HOLESIZE');  //Displayed spoke hole size (all holes)
var HOLE_COLOR     = E(NS_ + 'HOLE_COLOR');     //Spoke hole color
var HOLE_LINE_SIZE = E(NS_ + 'HOLE_LINE_SIZE'); //Spoke hole line thickness
var SHOW_HOLES	   = E(NS_ + 'SHOW_HOLES');     //Take a guess...

var COLOR_AXES = E(NS_ + 'COLOR_AXES');//
var LINE_SIZE_AXES = E(NS_ + 'LINE_SIZE_AXES');
var SHOW_AXES  = E(NS_ + 'SHOW_AXES'); //

var SPOKES		  = E(NS_ + 'spokes');   //<g> containing all spokes.
var RIM_HOLES	  = E(NS_ + 'rim_holes');//<g> containing rim holes.
var FLANGE1_HOLES = E(NS_ + 'holes_f1'); //<g> containing flange 1 holes.
var FLANGE2_HOLES = E(NS_ + 'holes_f2'); //<g> containing flange 2 holes.

var MESSAGE_BOX = E(NS_ + 'MSG_BOX');	 //Container div for msg div & [Close] btn.
var CLOSE_MSG	= E(NS_ + 'CLOSE_MSG'); //[Close] button for error message box.
var MESSAGE_DIV = E(NS_ + 'MESSAGE');	 //div for actual error message.

var SVG_WHEEL	= E(NS_ + 'box'); //Main <svg> element containing wheel & axes..
var G_WHEEL		= E(NS_ + 'wheel'); //<g> containing just the wheel elements: spokes, holes, rim, & flanges.

var SVG_CONTAINER_DIV = E(NS_ + 'The_SVG'); //Used just to read the generated html into the 'CONSOLE'.

var X_axis = E(NS_ + 'x-axis');
var Y_axis = E(NS_ + 'y-axis');
//end assignment of element reference.




//##### 
//##### NORMALIZE ID NAMES: R, or flange1 first, then "COLOR", or "SHOW", etc. : WH_R_COLOR2
//##### 








/*************************************************./
//Consider all raw size & x/y values to be mm,
//to coorespond directly to rim, hub, & spoke measurements.


/*************************************************/
var DEFAULT_VALUES = {
	'WHEEL_TYPE':0, //0=Standard, 1=Triplet, 2=Custom
	'ERD' :577,
	'NR'  :24,
	'NF1' :12, 
	'NF2' :12,
	'PCD1':38.5,
	'PCD2':50.6,
	'FTC1':37.7, //FtC & OSB affect spoke length calcs only (not display).
	'FTC2':17.1, //
	'OSB1':'',   //
	'OSB2':'',   //
	'SX1' :2,    
	'SX2' :2,
	'SHD' :2.6,  //Affects spoke length calcs only (not displayed size).
	'LACE_OPT':0 }


var DISPLAY_DEFAULTS = {
	'show_hide_DO':"none", //"none" or "inline-block"
	'COLOR1': '#477', //Spoke group colors
	'COLOR2': '#477', //
	'COLOR3': '#355', //
	'COLOR4': '#355', //
	'SHOW1':1,	 //  //1 or 0  ie: true or false
	'SHOW2':1,	 //				"
	'SHOW3':1,	 //				"
	'SHOW4':1,	 //				"
	'SD' :2,	 //				"
	'SHOW_R' :1, //				"
	'SHOW_F1':1, //				"
	'SHOW_F2':1, //				"
	'LINE_SIZE_R':1,
	'LINE_SIZE_F1':1,
	'LINE_SIZE_F2':1,
	'LINE_SIZE_AXES':1,
	'COLOR_R' : '#444',
	'COLOR_F1': '#AAA',
	'COLOR_F2': '#777',

	'HOLE_COLOR': '#777',
	'HOLE_LINE_SIZE': 1,
	'SHOW_HOLES': 1,
	'HOLESIZE' : 4, //Displayed size/diameter of spoke holes.

	'COLOR_AXES': '#999',
	'SHOW_AXES': 1, // true/false or 1/0
	'VIEWBOX_SIZE': 640 }; //Most wheels are < 600 ERD.
/*************************************************/




//##### ########################################################################
function Log(something, br, esc) {
	var console = E('WH_CONSOLE');
	if (typeof something === 'undefined') {
		console.innerHTML = ""
		console.style['display'] = "none";
		return;
	}

	if (esc) { something = escape_HTML(something + "") }
	
	if (br == true) { br = "<br>" } else { br = "" }
	
	console.innerHTML += something + br;
	console.scrollTop = console.scrollHeight;
	console.style['display'] = "inline-block";
}//end Log()
//##### ########################################################################
//##### ########################################################################
function escape_HTML(text) {
  var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };

  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}//end escape_HTML()
//##### ########################################################################





function Save_Settings(ls_name, defaults) { //*********************************/
	//Save as "id1:value1&id2:value..."

	var setting = "", all_settings = "";
	var x = 0;

	for (var id in defaults) {
		setting = E(NS_ + id);
		if (!setting) { continue }
		
		if (x++ > 0) { all_settings += "&"; }
		if (setting.type == "checkbox") { all_settings += setting.id + ":" + setting.checked; }
		else 							{ all_settings += setting.id + ":" + setting.value;   }
	}

	localStorage.setItem(ls_name, all_settings);

}//end Save_Settings() { //****************************************************/




function Load_Saved_Settings(ls_name) { //*************************************/
	var all_settigns = localStorage.getItem(ls_name);

	if (all_settigns == null) { return false; }

	var settings = all_settigns.split("&"); //get id:value pairs

	for (var x = 0; x < settings.length; x++){
		
		var id    = settings[x].split(":")[0];
		var value = settings[x].split(":")[1];
		
		if (!E(id)) { continue }; //skip inValid element id's.
		
		//.checked is boolean, and both strings "true" and "false" become false.
		if (E(id).type == "checkbox") { E(id).checked = (value == "true"); } 
		else						  { E(id).value   = value }
	}

	//##### VALIDATE LOADED VALUES ??

}//end Load_Saved_Settings() { //**********************************************/




function Load_Samples() { //***************************************************/

	WHEEL_TYPE.selectedIndex = DEFAULT_VALUES['WHEEL_TYPE'];

	ERD	  .value = DEFAULT_VALUES['ERD'];
	NR	  .value = DEFAULT_VALUES['NR'];
	NF[1] .value = DEFAULT_VALUES['NF1'];
	NF[2] .value = DEFAULT_VALUES['NF2'];
	PCD[1].value = DEFAULT_VALUES['PCD1'];
	PCD[2].value = DEFAULT_VALUES['PCD2'];
	FTC[1].value = DEFAULT_VALUES['FTC1'];
	FTC[2].value = DEFAULT_VALUES['FTC2'];
	OSB[1].value = DEFAULT_VALUES['OSB1'];
	OSB[2].value = DEFAULT_VALUES['OSB2'];
	SX[1] .value = DEFAULT_VALUES['SX1'];
	SX[2] .value = DEFAULT_VALUES['SX2'];
	SHD   .value = DEFAULT_VALUES['SHD'];

	LACE_OPT.selectedIndex = DEFAULT_VALUES['LACE_OPT'];

	Setup_Viewbox();

	Setup_Wheel_Type(1);

	Build_Wheel();

	Save_Settings(LS_WHEEL_SETTINGS, DEFAULT_VALUES);

}//end Load_Samples() { //*****************************************************/




function Clear_Settings() { //*************************************************/

	WHEEL_TYPE.selectedIndex = 0;

	ERD	  .value = '';
	NR	  .value = '';
	NF[1] .value = '';
	NF[2] .value = '';
	PCD[1].value = '';
	PCD[2].value = '';
	FTC[1].value = '';
	FTC[2].value = '';
	OSB[1].value = '';
	OSB[2].value = '';
	SX[1] .value = '';
	SX[2] .value = '';
	SHD   .value = '';

	LACE_OPT.selectedIndex = 0;

	Setup_Viewbox();

	Clear_Wheel();

	localStorage.removeItem(LS_WHEEL_SETTINGS);

}//end Clear_Settings() { //***************************************************/




function Load_Display_Defaults() { //******************************************/
	COLOR[1].value   = DISPLAY_DEFAULTS['COLOR1'];
	COLOR[2].value   = DISPLAY_DEFAULTS['COLOR2'];
	COLOR[3].value   = DISPLAY_DEFAULTS['COLOR3'];
	COLOR[4].value   = DISPLAY_DEFAULTS['COLOR4'];
	SHOW[1].checked = DISPLAY_DEFAULTS['SHOW1'];
	SHOW[2].checked = DISPLAY_DEFAULTS['SHOW2'];
	SHOW[3].checked = DISPLAY_DEFAULTS['SHOW3'];
	SHOW[4].checked = DISPLAY_DEFAULTS['SHOW4'];
	SD    .value   = DISPLAY_DEFAULTS['SD'];

	COLOR_R .value     = DISPLAY_DEFAULTS['COLOR_R'];
	COLOR_F1.value     = DISPLAY_DEFAULTS['COLOR_F1'];
	COLOR_F2.value     = DISPLAY_DEFAULTS['COLOR_F2'];
	LINE_SIZE_R .value = DISPLAY_DEFAULTS['LINE_SIZE_R'];
	LINE_SIZE_F1.value = DISPLAY_DEFAULTS['LINE_SIZE_F1'];
	LINE_SIZE_F2.value = DISPLAY_DEFAULTS['LINE_SIZE_F2'];
	SHOW_R .checked    = DISPLAY_DEFAULTS['SHOW_R'];
	SHOW_F1.checked    = DISPLAY_DEFAULTS['SHOW_F1'];
	SHOW_F2.checked    = DISPLAY_DEFAULTS['SHOW_F2'];

	COLOR_AXES.value     = DISPLAY_DEFAULTS['COLOR_AXES'];
	LINE_SIZE_AXES.value = DISPLAY_DEFAULTS['LINE_SIZE_AXES'];
	SHOW_AXES .checked   = DISPLAY_DEFAULTS['SHOW_AXES'];

	HOLE_COLOR.value     = DISPLAY_DEFAULTS['HOLE_COLOR'];
	HOLE_LINE_SIZE.value = DISPLAY_DEFAULTS['HOLE_LINE_SIZE'];
	SHOW_HOLES.checked   = DISPLAY_DEFAULTS['SHOW_HOLES'];

	HOLESIZE.value     = DISPLAY_DEFAULTS['HOLESIZE'];
}//end Load_Display_Defaults() //**********************************************/



function scroll_blur(event){ //************************************************/
	//Permit "clearing" focus, and some keyboard navigation while in <input>'s.

	//Normalize the event & which/key/charcode...
	if (!event) {var event = window.event;} //for IE
	var event_code = event.which || event.keyCode || event.charCode;
	
	var ESC = 27, AU = 38, AD = 40, PU = 33, PD = 34;

	//remove focus from input/select to allow keyboard arrows/pageup/pagedown/etc page scrolling.
	if (event_code == ESC) { D.activeElement.blur(); return; }

	if (event.target.tagName == "INPUT") {
		//Arrow down scrolls the page up, towards the bottom of the page, and vice-versa.
		if      (event_code == AU) { window.scrollBy(0, -38); }
		else if (event_code == AD) { window.scrollBy(0,  38); }
		else if (event_code == PU) { window.scrollBy(0,-400); }
		else if (event_code == PD) { window.scrollBy(0, 400); }
	}
}//end scroll_blur() //********************************************************/




function Show_Hide_Options(button, target_id, mode) { //***********************/
	//Toggle button.value & innerHTML, and Show or Hide target,

	if (button.value == "none") { button.value     = mode;   } //inline-block, etc...
	else 						{ button.value     = "none"; }

	E(target_id).style["display"] = button.value;

	//Only save if saved options already exist.
	var saved_options= localStorage.getItem(LS_DISPLAY_OPTIONS);
	if (saved_options) { Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS) }
}//end Show_Hide_Options() //**************************************************/





function Create_Spoke_Holes(hole_group, base_id, class1, class2, N, scale, shd, offset) { //***/
	//Create & position N spoke holes in <g id=group>, with radius of shd/2 (shd="spoke hole diameter")
	if (typeof offset == "undefined") { offset = 0 }

	var A = 360/N; //angle between holes
	
	var a = offset;	//angle to current hole from 0
	var cx, cy;		//coordinates for hole

	var odd = true;		//for alternating classes

	for (var sh = 1; sh <= N; sh++) {
		var full_id = base_id + sh;
		
		odd = !odd;
		if (odd) { var class_X = class1 } else { var class_X = class2 } //##### Keep? not really used...
		
		var classes = SPOKE_HOLES + " " + class_X;
		
		hole_group.innerHTML += '<circle id=' + full_id + ' class="' + classes + '" r="' + (shd/2) + '" cx="0" cy="0" />';
		
		cx = Math.round(Math.sin( (a/180) * Math.PI) * scale * 10000)/10000;
		cy = Math.round(Math.cos( (a/180) * Math.PI) * scale * 10000)/10000;
		
		E(full_id).setAttribute('cx', cx);
		E(full_id).setAttribute('cy', cy);
		
		a += A; //Spoke hole 1 is first hole at or after 0 degrees/"6 o'clock".
	}

	//##### Used during dev.  Keep?
	//#####E(base_id + "1").style["fill"]   = "red"; //Spoke 1
	//#####E(base_id + "1").style["stroke"] = "red"; //  "
	
}//end Create_Spoke_Holes() //*************************************************/




function Calc_Spoke_Length(flange, spoke_id) { //******************************/
	//Calculate actual spoke length in 3-d space, including flange-to-center measurement..
	
	if (!E(spoke_id)) { return ''; }
	
	//Get spoke ends
	var x1 = E(spoke_id).getAttribute('x1');
	var y1 = E(spoke_id).getAttribute('y1');
	var x2 = E(spoke_id).getAttribute('x2');
	var y2 = E(spoke_id).getAttribute('y2');
	
	var dx = x2 - x1;
	var dy = y2 - y1;

	var ftc = FTC[flange].value*1; //Final spoke length requires Flange to Center
	var osb = OSB[flange].value*1; //and OSB...
	var w = ftc + osb;

	var S = Math.sqrt(w*w + dx*dx + dy*dy) - SHD.value/2;

	return Math.round(S * 10)/10;
}//end Calc_Spoke_Length() //**************************************************/




function Calc_All_Spoke_Lengths(changed, integer, abs) { //********************/
	//Calc spoke lengths for both sides. Used by onchange of OSB & SHD.

	if (!Validate_Input(changed, integer, abs)) { return false }

	SL[1].value = Calc_Spoke_Length(1, SPOKE_ID_PREFIX + '1_1'); //WH_spoke_(flange)_(hole)
	SL[3].value = Calc_Spoke_Length(2, SPOKE_ID_PREFIX + '2_1');

	//##### For future. Maybe.  Before use, uncomment cooresponding html <input>'s & js elsewhere.
	//##### SL[2].value = Calc_Spoke_Length(1, SPOKE_ID_PREFIX + '1_2'); //##### For future use.
	//##### SL[4].value = Calc_Spoke_Length(2, SPOKE_ID_PREFIX + '2_2'); //##### For future use.

	Save_Settings(LS_WHEEL_SETTINGS, DEFAULT_VALUES);
}//end Calc_All_Spoke_Lengths() //*********************************************/





function Spoke_Length_Calculator(f) { //*****************************************
	//Tradtional method. For the most part. Not currently used.

	var ftc = FTC[f].value*1; //Final spoke length requires Flange to Center
	var osb = OSB[f].value*1; //and OSB...
	var w = ftc + osb;

	var aR  = 360/NR.value;    //angle between holes in Rim.
	var aF  = 360/NF[f].value; //angle between holes in Flange.

	//"zero cross" adjustment angle for triplets.
	if ((NR.value % NF[f].value) == 0) { var a0 = 0 } else { var a0  = aR - aF/2; }

	var rR  = ERD   .value/2;  //radius of Rim
	var rF  = PCD[f].value/2;  //radius of Flange
	var aF1 = SX[f].value*aF + LACE_OPT.value*a0; //angle to spoke hole in flange from "vertical".
	var aF1_rad = aF1/180 * Math.PI; //aF1 in radians
	var cos_aF1 = Math.round(Math.cos( aF1_rad )*10000)/10000;

	var S = Math.sqrt(w*w + rR*rR + rF*rF - 2*rR*rF*cos_aF1) - SHD.value/2;
		S = Math.round(S * 10)/10;

	Log(">" + S + "<",1);

	return S;
}//end Spoke_Length_Calculator() { //*******************************************




function Draw_Spoke(group, flange, flange_hole, rim_hole, color) { //**********/

	if (typeof color == "undefined") { color = "black" }

	var flange_hole_id = HUB_HOLE_ID_PREFIX + flange + HUB_HOLE_MESOFIX + flange_hole;
	var rim_hole_id	= RIM_HOLE_ID_PREFIX + rim_hole;

	var x1 = E(flange_hole_id).getAttribute('cx');
	var y1 = E(flange_hole_id).getAttribute('cy');
	var x2 = E(rim_hole_id).getAttribute('cx');
	var y2 = E(rim_hole_id).getAttribute('cy');

	var spoke_id = SPOKE_ID_PREFIX + flange + "_" + flange_hole;
	var classes = SPOKE_BASE_CLASS + ' ' + SPOKE_GROUP_PREFIX + group; //ex: 'WH_spoke WH_group1'
	var coords = ' x1="' + x1 +  '" y1="' + y1 +  '" x2="' + x2 +  '" y2="' + y2 +  '" ';
	var style = ' style="stroke:' + color + '"';

	var spoke = '<line id="' + spoke_id + '" class="' + classes+ '" ' + coords + style + '/>' + "\n";
	SPOKES.innerHTML += spoke;
	
	//Calculate & display final spoke length.
	if (flange_hole == 1) { //#####  || (flange_hole == 2)  <-For future use. Before use, uncomment cooresponding html <input>'s
		SL[group].value = Calc_Spoke_Length(flange, spoke_id);
	}
	
	//##### In case I want to calc ALL spokes.
	//##### Log(spoke_id + ") " + Calc_Spoke_Length(flange, spoke_id),1) 
}//end Draw_Spoke() //*********************************************************/




function Lacing_Option(f) { //*************************************************/
	/**************************************************************../
	tl;dr: "It's complicated..."  :)

    In a triplet wheel, with a given spoke count & cross, there are two lace patterns possible: "Type 1" and "Type 2"  :)
    In this program, it is presented as "Lacing Option".  Also, it only concerns the side with more spokes (ex: the 16
	spoke side of an 8:16 triplet). 
    Well, those three options: spoke count, spoke cross, and lace type;  presents us with a three body quatum gravitational
    paradoxical muonicly generational relativistic anti-matter equatorial teseract that has cost me many hours of time & much
    pounding of my head against a cinder block wall...

    Anyway, to determine the matching rim hole for a given flange hole, a modifier is needed, either 1 or -1, depending on
	the desired triplet type & other two conditions. But, it's not always the same. And sometimes it's different, except 
	when it's not...

    All 8 possible combinations (3 "bits": count, cross, type) are summerized in each of the two tables below. 
    The first was created by experimentation of all 8 combination of inputs.  The second is just a translation, but it 
	contains the conditions actually used in the if/then below.
    
        T1   |    T2            1   |   -1               NR: Number of holes in the Rim (24, 27, 32, etc.)
     --------+--------      --------+--------            SX: Spoke Cross (1x, 2x, 3x, etc.)
     NR SX * | NR SX *      NR SX T | NR SX T            * : Modifier (1 or -1)
     --------+--------      --------+--------            T : Triplet Type (T1 or T2)
     E  E  1 | E  E -1      E  E  1 | E  O  1        
     O  E  1 | O  E -1      O  E  1 | O  O  1     \ | /    | | |
     E  O -1 | E  O  1      E  O  2 | E  E  2      \|/     | | |   (The "middle spoke" is on the opposite flange.         )
     0  O -1 | 0  O  1      O  O  2 | O  E  2       X      | | |  
                                                   /|\     | | |  
                                                  Type 1   Type 2 
    
    Now, in basic spoke calc math, it's much simpler, because all that matters is spoke cross - we don't care about the voodoo
	involved in determining matching spoke holes in space.  But here, holes matter. And space.  And time.  I think. I guess.  
	Maybe. I don't know.  But it works now!  :)
    /****************************************************************/


	var NRE = (NR.value    % 2  == 0); // Even number of rim holes?
	var SXE = (SX[f].value % 2  == 0); // Even Spoke cross?
	var T1  = (LACE_OPT.selectedIndex == 0); // Triplet/Lacing Type 1?

	if ( (NRE && SXE && T1) || (!NRE && SXE && T1) || (NRE && !SXE && !T1) || (!NRE && !SXE && !T1) )
		 { return  1 } 
	else { return -1 }
}//end Lacing_Option() //******************************************************/




function Create_Spoke_Groups(g1, g2, nr, nf, sx, f, color ) { //***************/
	sx = Math.floor(sx);

	if (nf < 1) { return }

	var gn = g1; //Used to toggle between g1 & g2
	var d  = 1;   //Direction. ie: leading or trailing spokes.

	var r_skip = nr/nf; //Normally 2, but can be 3 (flange 1), then 3/2 (flange 2) for triplets.

	//Flange 1 hole 1 aligns to rim hole 1.  Flange 2 hole 1 aligns to rim hole 2 (generally, if NF1 <= NF2)...
	if (f == 2) { var f_skip = r_skip/2 } else { var f_skip = 0 }

	for (var h_hole = 1; h_hole <= nf; h_hole += 1) {
		
		var r_hole = (h_hole-1 + sx*d*Lacing_Option(f)) * r_skip + 1 + f_skip
		
		r_hole = Math.round(r_hole) //Needed for triplets. I don't like it, but can't figure out another way...
		
		if (r_hole > nr) {r_hole -= nr;}
		if (r_hole <  1) {r_hole += nr;}
		
		Draw_Spoke(gn,  f,  h_hole,  r_hole ,  color[gn]);
		if (gn == g2) { var gn = g1 } else { var gn = g2 }
		
		d = -d; //toggle direction, aka leading/trailing spokes.
	}
}//end Create_Spoke_Groups() //************************************************/




function Make_Rim(save) { //***************************************************/
	//Adjust displayed rim radius so spoke ends only touch inner radius, not middle/actual radius.
	var rim_radius = ERD.value/2 + LINE_SIZE_R.value/2 - .5;
	RIM.setAttribute('r', rim_radius);
	RIM.style['stroke']	= COLOR_R.value;
	RIM.style['stroke-width'] = LINE_SIZE_R.value;
	Setup_Viewbox();
	if (save) { Save_Settings(LS_WHEEL_SETTINGS, DEFAULT_VALUES) }
}//end Make_Rim() { //*********************************************************/



function Setup_Wheel(erd, nr, nf1, nf2, pcd1, pcd2, sx1, sx2, shd, spoke_colors) { /****/
	//shd as used here, and in Create_Spoke_Holes(), only affects 
	//displayed spoke hole size, and not spoke length calcs.

	var AF = 360/nf2; //Angle between holes in Flange.
	var offset_f1_f2 = AF/2; //Offset angle between left & right hub flange holes. The radial side is "0".
							 
	var rotate = 0; //180 rotates wheel so that "spoke 1" is at 12 o'clock. Helped during dev. Now, not so much.

	//Draw basic rim & flange circles..
	var rim_radius = erd/2 + LINE_SIZE_R.value/2 - .5;
	RIM.setAttribute('r', rim_radius); //
	FLANGE1.setAttribute('r', pcd1/2); //erd & pcd's are "D"iameters, but SVG <circle>'s require radii...
	FLANGE2.setAttribute('r', pcd2/2); //

	var f1_prefix = HUB_HOLE_ID_PREFIX + "1" + HUB_HOLE_MESOFIX;
	var f2_prefix = HUB_HOLE_ID_PREFIX + "2" + HUB_HOLE_MESOFIX;
	Create_Spoke_Holes( RIM_HOLES     , RIM_HOLE_ID_PREFIX , RIM_HOLE_CLASS, RIM_HOLE_CLASS, nr , erd/2 , shd, 0);
	Create_Spoke_Holes( FLANGE1_HOLES , f1_prefix, HUB_HOLE_CLASS, HUB_HOLE_CLASS, nf1, pcd1/2, shd, 0);
	Create_Spoke_Holes( FLANGE2_HOLES , f2_prefix, HUB_HOLE_CLASS, HUB_HOLE_CLASS, nf2, pcd2/2, shd, offset_f1_f2);

	Create_Spoke_Groups(1, 2, nr, nf1, sx1, 1, spoke_colors);
	Create_Spoke_Groups(3, 4, nr, nf2, sx2, 2, spoke_colors);

	Set_Wheel_Styles();

	G_WHEEL.setAttribute('transform', " rotate(" + rotate + ")");

	//##### Log(SVG_CONTAINER_DIV.innerHTML,1,1) //##### 
}//end Setup_Wheel() /*********************************************************/




function Set_Wheel_Styles() { //***********************************************/
	Make_Rim(); //Rim line size affects displayed rim radius.
	FLANGE1.style['stroke'] = COLOR_F1.value;
	FLANGE2.style['stroke'] = COLOR_F2.value;
	FLANGE1.style['stroke-width'] = LINE_SIZE_F1.value*1;
	FLANGE2.style['stroke-width'] = LINE_SIZE_F2.value*1;

	for (var group = 1; group <= 4; group++) {
		Set_Style_by_Class( SPOKE_GROUP_PREFIX + group, "stroke-width", SD.value);
		Set_Style_by_Class( SPOKE_GROUP_PREFIX + group, "stroke"      , COLOR[group].value);
		Show_Hide_Class(SPOKE_GROUP_PREFIX + group, SHOW[group].checked);
	}

	Set_Style_by_Class(SPOKE_HOLES, 'stroke-width', HOLE_LINE_SIZE.value);
	Set_Style_by_Class(SPOKE_HOLES, "stroke", HOLE_COLOR.value);
	Show_Hide_Class( SPOKE_HOLES, SHOW_HOLES.checked);

	Set_Style_by_Class( AXIS_CLASS, 'stroke-width', LINE_SIZE_AXES.value )
	Set_Style_by_Class( AXIS_CLASS, "stroke", COLOR_AXES.value )
	Show_Hide_Class( AXIS_CLASS, SHOW_AXES.checked )

}//end Set_Wheel_Styles() { //*************************************************/




function Clear_Wheel() { //****************************************************/
	RIM    .setAttribute('r', 0);
	FLANGE1.setAttribute('r', 0);
	FLANGE2.setAttribute('r', 0);
	RIM_HOLES	 .innerHTML = "";
	FLANGE1_HOLES.innerHTML = "";
	FLANGE2_HOLES.innerHTML = "";
	SPOKES		 .innerHTML = "";
	SL[1].value = '';
	SL[3].value = '';
	//#####SL[2].value = ''; //##### For future use.
	//#####SL[4].value = ''; //##### For future use.
}//end Clear_Wheel() //********************************************************/




function Build_Wheel(save, input, integer) { //********************************/

	if (input) {
		
		if (!Validate_Input(input, integer)) { return false }
		
		//Check if basic "cleaned" value from Validate_Input() has really changed.
		if (input.value == PRIOR_VALUE) { return false }
		
		PRIOR_VALUE = input.value; //Also set in onfocus events.
	}


	Clear_Wheel(); 


	var Spoke_Colors = ["", COLOR[1].value, COLOR[2].value,  COLOR[3].value, COLOR[4].value ];

  //Setup_Wheel(ERD, NR, NF1, NF2, PCD1, PCD2, SX1, SX2, SHD, Spoke_Colors)
	Setup_Wheel( ERD.value*1, NR.value*1, NF[1].value*1, NF[2].value*1,
				 PCD[1].value*1, PCD[2].value*1, SX[1].value*1, SX[2].value*1,
				 HOLESIZE.value*1, Spoke_Colors
				);

	//##### Spoke_Length_Calculator(1); //For future use...
	//##### Spoke_Length_Calculator(2); //Maybe...


	if (save) { Save_Settings(LS_WHEEL_SETTINGS, DEFAULT_VALUES) }

}//end Build_Wheel() //********************************************************/




function Error_Notice(what, msg) {//*******************************************/
	//what: id of changed input.
	if (typeof msg == 'undefined') { msg = "" }
	
	if (what) { msg = 'Invalid input: "' + what.value + '".<br>' + msg; }
	MESSAGE_DIV.innerHTML = msg;
	MESSAGE_BOX.style['visibility'] = "visible";
	PRIOR_FOCUS = what.id;
	what.value = PRIOR_VALUE; //Prior to change...
	setTimeout(function() {CLOSE_MSG.focus()},25); //setTimeout needed for <select>s. I don't know why.
}//end Error_Notice() //*******************************************************/





function Close_Message() { //**************************************************/
	MESSAGE_BOX.style['visibility'] = "hidden";
	MESSAGE_DIV.innerHTML = "";
	if (E(PRIOR_FOCUS).tagName == "INPUT") { E(PRIOR_FOCUS).select() }
	E(PRIOR_FOCUS).focus();
}//end Close_Message() { //****************************************************/




function Validate_NR() { //****************************************************/

	if ((NR.value*1 > MAX[NR.id])) { //(NR.value*1 < 1) ||
		var msg = "Maximum value for N<sub>R</sub>: " + MAX[NR.id] + ".<br>";
		Error_Notice(NR, msg);
		return false;
	}
	
	if (WHEEL_TYPE.value == 0) { //Standard wheel lacings
		
		//NR must be even in standard wheels.
		if(NR.value%2 != 0) {
			var msg = "Number of rim spoke holes (N<sub>R</sub>) must be even for a standard wheel.";
			Error_Notice(NR, msg);
			return false;
		}
		
		NF[1].value = NR.value/2;
		NF[2].value = NR.value/2;
		
		//Also, if NR is not divisible by 4 (NF is odd), cross can only be 0.
		if(NR.value%4 != 0) { SX[1].value = 0; SX[2].value = 0; }
	}
	else if (WHEEL_TYPE.value == 1) { //Triplets
		
		//NR must be divisible by 3.
		if (NR.value%3 != 0) {
			var msg= "Number of rim spoke holes (N<sub>R</sub>) must be divisible by 3 for wheel type Triplet.";
			Error_Notice(NR, msg);
			NR.value = PRIOR_VALUE;
			return false;
		}
		
		NF[1].value = NR.value/3;
		NF[2].value = NF[1].value*2;
		
		//In triplets, if NR is odd, NF[1] is odd, so SX[1] must be 0.
		if (NR.value%2 != 0) { SX[1].value = 0 }
		
		//Practical default cross values for most triplets spoke counts. Even impractical ones.
		if (NR.value*1 < 15) { SX[2].value = 1 } else
		if (NR.value*1 < 24) { SX[2].value = 2 } else
		if (NR.value*1 < 36) { SX[2].value = 3 } else
							 { SX[2].value = 4 }
	}//end if (WHEEL_TYPE.value)
	
	
	//If NR==0, clear the spokes & rim holes.
	if (NR.value*1 == 0) {
		RIM_HOLES	 .innerHTML = "";
		SPOKES		 .innerHTML = "";
		SL[1].value = '';
		SL[3].value = '';
		//##### SL[2].value = ''; //##### For future use.
		//##### SL[4].value = ''; //##### For future use.
		
		//And, if not a "Custom" wheel...
		if (WHEEL_TYPE.value != 2) {
			FLANGE1_HOLES.innerHTML = "";
			FLANGE2_HOLES.innerHTML = "";
		}
		
		return false;
	} 
	
	return true;
}//end Validate_NR() { //******************************************************/




function Validate_NF(nf, f) { //***********************************************/

	var id = nf.id
	var value = nf.value * 1;

	if (isNaN(value)) {
		Error_Notice(nf);
		return false;
	}

	//Check if basic "cleaned" value from Build_Wheel() has really changed.
	if (value == PRIOR_VALUE) { return false }

	if (value > MAX[id]) { //(value < 1) ||
		var msg = "Valid range for N<sub>R</sub> & N<sub>F</sub>'s:<br>1 to " + MAX[id] + ".<br>";
		Error_Notice(nf, msg);
		return false;
	}

	if ( NF[1].value*1 > NF[2].value*1) { //Things mess up otherwise...
		var msg = "Number of flange holes (N<sub>F</sub>): Side 1  must be less than or equal to Side 2.<br>";
		Error_Notice(nf, msg);
		return false;
	}

	//Also, if NF is is odd, cross can only be 0.
	if(nf.value%24 != 0) { SX[f].value = 0; }

	return true;
}//end Validate_NF() //********************************************************/




function Validate_SX(sx, f) { //********************************************/

	//Long past practical, and the point things repeat or logically break...
	if (sx.value*1 > NF[f].value*1) {
		var msg = "Spoke cross cannot exceed spoke count for flange.";
		Error_Notice(sx, msg);
		return false;
	}

	if ((NF[f].value % 2 != 0) && (sx.value*1 != 0)) {
		var msg = "Spoke cross must be 0 if flange has an odd number of spoke holes (" + NF[f].value + ").";
		Error_Notice(sx, msg);
		return false;
	}

	return true;
}//end Validate_SX() //********************************************************/




function Validate_Input(input, integer, neg) { //******************************/

	if (isNaN(input.value)) {
		Error_Notice(input);
		return false;
	}

	var id = input.id;
	input.value = input.value.trim();

	if (input.value != "") {
		if (integer) { input.value = Math.floor( parseInt(input.value) ); }
		else 		 { input.value = parseFloat(input.value); }
	}
	
	if (!neg) { input.value = Math.abs(input.value) }

	return true;
}//end Validate_Input() { //***************************************************/




function Setup_Viewbox() { //**************************************************/

	var erd = ERD.value*1;
	var rim = LINE_SIZE_R.value*1;
	var total = erd + rim * 2;

	if (total > DISPLAY_DEFAULTS['VIEWBOX_SIZE']) { 
		var view_box_size = total + 30 //THe +30 is so viewbox doesn't change for every little ERD change.
	} else {
		var view_box_size = DISPLAY_DEFAULTS['VIEWBOX_SIZE']
	}

	//Setup viewbox...
	var view_W = view_box_size; //Width
	var view_H = view_box_size; //Height
	var V_offset = (-view_H/2); //Vertical Offset
	SVG_WHEEL.setAttribute('width',  view_W);
	SVG_WHEEL.setAttribute('height', view_H);
	SVG_WHEEL.setAttribute('viewBox', (-view_W/2) + " " + V_offset + " " + view_W + " " + view_H);

	//Set xy axis...
	var max_XY = view_box_size/2;
	X_axis.setAttribute('x1', -max_XY);
	X_axis.setAttribute('y1', 0);
	X_axis.setAttribute('x2',  max_XY);
	X_axis.setAttribute('y2', 0);

	Y_axis.setAttribute('x1', 0);
	Y_axis.setAttribute('y1', -max_XY);
	Y_axis.setAttribute('x2', 0);
	Y_axis.setAttribute('y2',  max_XY);

}//end Setup_Viewbox() { //****************************************************/




function Show_Hide_Class(classname, show, save) { //***************************/
	var items = D.getElementsByClassName(classname);

	for (var s = 0; s < items.length; s++)
	{
		if (show) { items[s].style['display'] = "" ;   }
		else 	  { items[s].style['display'] = "none" }
	}

	if (save) { Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS); }

}//end Show_Hide_Class() //****************************************************/




function Show_Hide(what, show, save) { //**************************************/
	if (show) { what.style['display'] = ""     }
	else 	  { what.style['display'] = "none" }

	if (save) { Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS); }

}//end Show_Hide() //**********************************************************/




function Set_Style_by_Class(classname, style, value, save) { //****************/
	var objects = D.getElementsByClassName(classname);
	for (var s = 0; s < objects.length; s++) { objects[s].style[style] = value; }

	if (save) { Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS); }

}//end Set_Style_by_Class() //*************************************************/




function Set_Save_Style(element, style, value) { //***************************/
	element.style[style] = value;
	Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS); 
}//end Set_Save_Style() //****************************************************/





function Set_Attribute_by_Class(classname, attribute, value) { //**************/
	var objects = D.getElementsByClassName( classname );
	for (var x = 0; x < objects.length; x++) { objects[x].setAttribute( attribute, value ); }
}//end Set_Attribute_by_Class() //*********************************************/




function Setup_Wheel_Type(nfsx_too) { //***************************************/
	//nfsx_too: when loading saved values, this is false (or undefined).

	if (WHEEL_TYPE.value == 0) { //"Standard" wheels
		
		//Round up to next possible "standard" spoke count (divisible by 4).
		var NR_mod4 = (NR.value*1) % 4;
		if(NR_mod4 != 0) { NR.value = NR.value*1 + (4 - NR_mod4); }
		
		NF[1].readOnly = true;
		NF[2].readOnly = true;
		NF[1].tabIndex = -1;
		NF[2].tabIndex = -1;

		if (nfsx_too) {
			NF[1].value = NR.value/2;
			NF[2].value = NR.value/2;
		}
	} else 
	
	if (WHEEL_TYPE.value == 1) { //"Triplet"
		
		NF[1].readOnly = true;
		NF[2].readOnly = true;
		NF[1].tabIndex = -1;
		NF[2].tabIndex = -1;
		
		if (nfsx_too) {
			//Just some likely values for defaults. User can change.
			NR.value = 24; 
			NF[1].value = NR.value/3;
			NF[2].value = NF[1].value*2;
			
			//Cross values for a triplet with a spoke count of 24.
			SX[1].value = 0;
			SX[2].value = 3;
		}
		
	} else {					 //"Custom"
		NF[1].readOnly = false;
		NF[2].readOnly = false;
		NF[1].tabIndex = 0;
		NF[2].tabIndex = 0;
		
		return false; //No need to Build_Wheel(), as nothing has changed.
	}
	
	return true; //Rebuild_Wheel() in case NF or SX values where changed above.
}//end Setup_Wheel_Type() { //*************************************************/




function Assign_Events() { //**************************************************/

	//Save prior/existing value in case of error in new value.
	var settings = [WHEEL_TYPE.id, ERD.id, NR.id, NF[1].id, NF[2].id, PCD[1].id, PCD[2].id, FTC[1].id, FTC[2].id, OSB[1].id, OSB[2].id, SX[1].id, SX[2].id, SHD.id];
	for (var x = 0; x < settings.length; x++) {
		//PRIOR_VALUE also set in Build_Wheel().
		E(settings[x]).addEventListener("focus", function() { PRIOR_VALUE = this.value; });
	}


	LOAD_SAMPLES  .addEventListener("click", function () { Load_Samples()   });
	CLEAR_SETTINGS.addEventListener("click", function () { Clear_Settings() });

	WHEEL_TYPE.addEventListener("change", function() {
		if (Setup_Wheel_Type(1)) { Build_Wheel(1) }
		var msg = NOTICE_MESSEGE;
		if (WHEEL_TYPE.value == 2) { Error_Notice('', msg) }
	});

	ERD.addEventListener("change", function() { Build_Wheel(1, this, 0); Setup_Viewbox(); });

	NR   .addEventListener("change", function() { if (Validate_NR())        { Build_Wheel(1, this, 1); } });
	NF[1].addEventListener("change", function() { if (Validate_NF(this, 1)) { Build_Wheel(1, this, 1); } });
	NF[2].addEventListener("change", function() { if (Validate_NF(this, 2)) { Build_Wheel(1, this, 1); } });

	PCD[1]  .addEventListener("change", function() { Build_Wheel(1, this, 0); });
	PCD[2]  .addEventListener("change", function() { Build_Wheel(1, this, 0); });
	FTC[1]  .addEventListener("change", function() { Build_Wheel(1, this, 0); });
	FTC[2]  .addEventListener("change", function() { Build_Wheel(1, this, 0); });

	SX[1].addEventListener("change", function() { if (Validate_SX(this,1)) { Build_Wheel(1, this, 1); } });
	SX[2].addEventListener("change", function() { if (Validate_SX(this,2)) { Build_Wheel(1, this, 1); } });

	LACE_OPT.addEventListener("change", function() { Build_Wheel(1) });
	
	// Only need to recalc final spoke lengths. OSB & SHD are ignored in display calculations for <line> endpoints.
	OSB[1].addEventListener("change", function() { Calc_All_Spoke_Lengths(this, 0, 1); });
	OSB[2].addEventListener("change", function() { Calc_All_Spoke_Lengths(this, 0, 1); });
	SHD   .addEventListener("change", function() { Calc_All_Spoke_Lengths(this, 0, 0); });



	SHOW_HIDE_DO.addEventListener("click", function() { Show_Hide_Options(this, DISPLAY_OPTIONS.id, "inline-block"); });

	COLOR[1].addEventListener("change", function() { Set_Style_by_Class( SPOKE_GROUP_PREFIX + '1', "stroke", this.value, 1); });
	COLOR[2].addEventListener("change", function() { Set_Style_by_Class( SPOKE_GROUP_PREFIX + '2', "stroke", this.value, 1); });
	COLOR[3].addEventListener("change", function() { Set_Style_by_Class( SPOKE_GROUP_PREFIX + '3', "stroke", this.value, 1); });
	COLOR[4].addEventListener("change", function() { Set_Style_by_Class( SPOKE_GROUP_PREFIX + '4', "stroke", this.value, 1); });

	SHOW[1].addEventListener("change", function() { Show_Hide_Class( SPOKE_GROUP_PREFIX + '1', this.checked, 1); });
	SHOW[2].addEventListener("change", function() { Show_Hide_Class( SPOKE_GROUP_PREFIX + '2', this.checked, 1); });
	SHOW[3].addEventListener("change", function() { Show_Hide_Class( SPOKE_GROUP_PREFIX + '3', this.checked, 1); });
	SHOW[4].addEventListener("change", function() { Show_Hide_Class( SPOKE_GROUP_PREFIX + '4', this.checked, 1); });

	//Spoke "diameter" (line width). Affects display of spokes only (not calcs).
	SD.addEventListener("change", function() { 
		for (var group=1; group <= 4; group++) {
			Set_Style_by_Class( SPOKE_GROUP_PREFIX + group , "stroke-width", this.value, 1);
		}
	} )

	COLOR_R .addEventListener("change", function() { Set_Save_Style(RIM,     'stroke', this.value); });
	COLOR_F1.addEventListener("change", function() { Set_Save_Style(FLANGE1, 'stroke', this.value); });
	COLOR_F2.addEventListener("change", function() { Set_Save_Style(FLANGE2, 'stroke', this.value); });

	LINE_SIZE_R.addEventListener("change", function() { Make_Rim(1); });

	LINE_SIZE_F1  .addEventListener("change", function() { Set_Save_Style(FLANGE1, 'stroke-width', this.value); });
	LINE_SIZE_F2  .addEventListener("change", function() { Set_Save_Style(FLANGE2, 'stroke-width', this.value); });

	SHOW_R .addEventListener("change", function() { Show_Hide(RIM    , this.checked, 1) });
	SHOW_F1.addEventListener("change", function() { Show_Hide(FLANGE1, this.checked, 1) });
	SHOW_F2.addEventListener("change", function() { Show_Hide(FLANGE2, this.checked, 1) });

	COLOR_AXES    .addEventListener("change", function() { Set_Style_by_Class( AXIS_CLASS, "stroke", this.value, 1); });
	LINE_SIZE_AXES.addEventListener("change", function() { Set_Style_by_Class(AXIS_CLASS, 'stroke-width', this.value, 1); });
	SHOW_AXES     .addEventListener("change", function() { Show_Hide_Class( AXIS_CLASS, this.checked, 1); });

	HOLE_COLOR    .addEventListener("change", function() { Set_Style_by_Class(SPOKE_HOLES, "stroke"      , this.value, 1); });
	HOLE_LINE_SIZE.addEventListener("change", function() { Set_Style_by_Class(SPOKE_HOLES, 'stroke-width', this.value, 1); });
	SHOW_HOLES    .addEventListener("change", function() { Show_Hide_Class(SPOKE_HOLES, this.checked, 1); });
	
	HOLESIZE.addEventListener("change", function() { 				//HOLESIZE is diameter
		Set_Attribute_by_Class( RIM_HOLE_CLASS, 'r', this.value/2); //set *radius* of holes (this.value/2)
		Set_Attribute_by_Class( HUB_HOLE_CLASS, 'r', this.value/2);
		Save_Settings(LS_DISPLAY_OPTIONS, DISPLAY_DEFAULTS);
	});

	RESET_OPTIONS.addEventListener("click", function() {
		Load_Display_Defaults();
		Set_Wheel_Styles();
		Set_Attribute_by_Class( RIM_HOLE_CLASS, 'r', HOLESIZE.value/2);
		Set_Attribute_by_Class( HUB_HOLE_CLASS, 'r', HOLESIZE.value/2);
		Set_Style_by_Class( AXIS_CLASS, "stroke", this.value);
		Show_Hide_Class( AXIS_CLASS, SHOW_AXES.checked);
		localStorage.removeItem(LS_DISPLAY_OPTIONS);
	});

	CLOSE_MSG.addEventListener("blur" , function() { Close_Message() });
	CLOSE_MSG.addEventListener("click", function() { Close_Message() });
}//end Assign_Events() //******************************************************/




function WH_Init() { //********************************************************/

	Assign_Events();

	Load_Saved_Settings(LS_WHEEL_SETTINGS);  //If any...

	Load_Display_Defaults();

	Load_Saved_Settings(LS_DISPLAY_OPTIONS); //  "		

	Setup_Viewbox();

	Setup_Wheel_Type();

	Build_Wheel();

	DISPLAY_OPTIONS.style["display"] = SHOW_HIDE_DO.value;

	//Reduce the visually jarring, if brief,  jumping around of page elements during page load.
	CONTAINER.style['visibility'] = "visible";
	CONTAINER.style.opacity = '1'

	ERD.focus(); //Seems like a good place to land.
	
}//end WH_Init() //************************************************************/


document.addEventListener("keydown", function(event) {scroll_blur(event)});
window.addEventListener("load", function(){WH_Init()});
//*****************************************************************************/
})();</script>
