<!DOCTYPE html>
<meta charset="utf-8"/>



<!--=========================================================================..>
The SVG Wheel Maker
v.beta.15


Copyright © 2017 https://github.com/Self-Evident

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
<!--=========================================================================-->



<style>
body {margin: 0}
* { margin: 0; padding: 0; box-sizing: border-box; }

/*** The prefix "WH_" simple means "WHeel" ***/

#WH_CONTAINER { position: relative }
#WH_The_SVG   { display: inline-block; }
#WH_left_side { display: inline-block; vertical-align: top }

.WH_settings 		{
	border: solid 1px blue;
	border-collapse: collapse;
	font-family: arial;
	width: 10.5rem;
	text-align: center;
}
.WH_settings th 	{ text-align: left; padding: 0 3px }
.WH_settings td 	{ }
.WH_settings input  { width: 3rem; text-align: center; }
.WH_settings select { width: 3rem; text-align: center; }
div.WH_settings 	{ padding: 2px 0 }
.WH_settings hr 	{ margin: .1em 3px .5em 3px }

#WH_ERD	 { fill: none; stroke: #999; }
.WH_svg	 { border: solid 0px gray; display: inline-block; margin: auto; }
.WH_axis { stroke: #999; stroke-width: 1; stroke-dasharray: 3,3; }
.WH_rsh	 { fill: none; stroke: #777; } /*rim spoke holes*/
.WH_hsh	 { fill: none; stroke: #777; } /*hub spoke holes*/
.WH_hsh2 { fill: none; stroke: #ccc; } /*hub spoke holes 2*/
.WH_spoke{ fill: none; stroke: #000; stroke-width: 2; }
.WH_pcd	 { fill: none; stroke: #000; stroke-width: 1; }

.WH_notes {font-siZe: .8rem}

.WH_lengths {
	display:inline-block;
	vertical-align: top;
	border: solid 1px blue;
	padding: 0 3px;
	width: 5rem;
	font-family: arial;
	text-align: center; 
}
	
.WH_lengths p  {margin: 0 0 .8rem 0}
.WH_lengths hr {margin: 0 0 .8rem 0}
.WH_lengths input { width: 3.5rem; text-align: center; font-size: 1rem; }



#CONSOLE { 
	vertical-align:top;
	display: none; 
	font-family: Courier New; 
	font-size: .8em; 
	border: solid 1px red;
	max-height: 40rem ;
	XXXXX_SX22.75rem; 
	overflow-y: scroll; 
	word-break: break-all;
	padding: 0 .5em;
}


#WH_MSG_BOX {
	width	: 13rem;
	position: absolute;
	top		: 2rem;
	left	: 11rem;
	border	: solid 2px red;
	font-family		: arial;
	text-align		: center;
	background-color: white;
	border-radius	: 5px;
	visibility		: hidden;
}


#WH_CLOSE_MSG {
	width	: 2.75rem;
	position: absolute;
	top		: 0rem;
	left	: 10.0rem;
}
</style>

<body id=body>


<div id=WH_CONTAINER>
<div id=WH_MSG_BOX><button id=WH_CLOSE_MSG>Close</button><br><div id=WH_MESSEGE></div><br></div>

<div id=WH_left_side>

<table class=WH_settings>
<tr><td colspan=2><b>Wheel Settings</b></td></tr>
<tr><td colspan=2><hr></td></tr>
<tr><th>ERD:</th><td><input id=ERD  type=text value=580></td></tr>
<tr><th>NR: </th><td><input id=NR   type=text value=24 ></td></tr>
<tr>
	<th>NF:</th>
	<td>
		<input id=NF1  type=text>
		<input id=NF2  type=text>
	</td>
</tr>
<tr>
	<th>PCD:</th>
	<td>
		<input id=PCD1 type=text>
		<input id=PCD2 type=text>
	</td>
</tr>
<tr>
	<th>FtC:</th>
	<td>
		<input id=FTC1 type=text>
		<input id=FTC2 type=text>
	</td>
</tr>
<tr>
	<th>X:</th>
	<td>
		<input id=SX1  type=text>
		<input id=SX2  type=text>
	</td>
</tr>
<tr>
	<th>SHD:</th>
	<td><input id=SHD  type=text></td>
</tr>
<tr><td colspan=2 class=WH_notes>(SHD affects Spoke Length Calcs only.)<br><br></td></tr>
<tr>
	<th colspan=2>Lace Option:
		<select id=LACE_OPT name=LACE_OPT>
			<option value= 1>1&nbsp;</option>
			<option value=-1>2&nbsp;</option>
		</select>
	</th>
</tr>
</table><!--//end Wheel Settings -->


<br>
<table class=WH_settings>
<tr><td colspan=3><b>Display Options</b></td></tr>
<tr><td colspan=3><hr></td></tr>
<tr><td colspan=3><b><u>Spokes</u></b></td></tr>
<tr>
	<td>Group</td>
	<td>Color</td>
	<td>Show?</td>
</tr>
<tr>
	<td>1</td>
	<td><input id=WH_COLOR1 type=text></td>
	<td><input id=WH_SHOW1  type=checkbox></td>
</tr>
<tr>
	<td>2</td>
	<td><input id=WH_COLOR2 type=text></td>
	<td><input id=WH_SHOW2  type=checkbox></td>
</tr>
<tr>
	<td>3</td>
	<td><input id=WH_COLOR3 type=text></td>
	<td><input id=WH_SHOW3  type=checkbox></td>
</tr>
<tr>
	<td>4</td>
	<td><input id=WH_COLOR4 type=text></td>
	<td><input id=WH_SHOW4  type=checkbox></td>
</tr>
	<!--Spoke Diameter-->
<tr><td colspan=3><br>Size: <input id=WH_SD type=text></td></tr>

<tr><td colspan=3>&nbsp;</td></td>
<tr><td colspan=3><b><u>Rim &amp; Flange</u></b></td></tr>
<tr>
	<td></td>
	<td>Color</td>
	<td>Show?</td>
</tr>
<tr>
	<td>Rim</td>
	<td><input id=WH_COLOR_R type=text></td>
	<td><input id=WH_SHOW_R  type=checkbox></td>
</tr>
<tr>
	<td>F1</td>
	<td><input id=WH_COLOR_F1 type=text></td>
	<td><input id=WH_SHOW_F1  type=checkbox></td>
</tr>
<tr>
	<td>F2</td>
	<td><input id=WH_COLOR_F2 type=text></td>
	<td><input id=WH_SHOW_F2  type=checkbox></td>
</tr>
<tr><td colspan=3>&nbsp;</td></td>
<tr>
	<td>Axes</td>
	<td><input id=WH_COLOR_AXES type=text></td>
	<td><input id=WH_SHOW_AXES  type=checkbox></td>
</tr>
<tr><td colspan=3><br>Hole Size:  <input id=WH_HOLESIZE type=text></td></tr>
<tr><td colspan=3 class=WH_notes>(Affects displayed size only.)</td></tr>
</table><!--//end Display Options-->

<br>
</div><!--//end WH_left_side -->


<!--
	Consider all raw size & x/y values to be mm, which coorespond directly 
    to rim, hub, & spoke measurements.
-->
<div id=WH_The_SVG>
<svg id="WH_box" class="WH_svg">
	<title>Wheel</title>
	<g id="WH_axes">
		<line id="WH_x-axis" class="WH_axis"  x1="-305"	y1=   "0"	x2="305"	y2=  "0"/>
		<line id="WH_y-axis" class="WH_axis"  x1=   "0"	y1="-305"	x2=  "0"	y2="305"/>
	</g>

	<g id="WH_wheel">
		<circle id="WH_ERD"  class="WH_erd" r=""/>
		<circle id="WH_PCD1" class="WH_pcd" r=""/>
		<circle id="WH_PCD2" class="WH_pcd" r=""/>
		
		
		<g id=WH_Holes_and_Spokes>
			<g id="WH_rim_holes"></g>
			<g id="WH_flange_1"></g>
			<g id="WH_flange_2"></g>
			<g id="WH_spokes"></g>
		</g>
	</g><!-- end id=WH_wheel -->
</svg>
</div><!-- end  id=WH_The_SVG -->

<div class=WH_lengths>
<p><b>Spoke Lengths</b>
<hr>
<p>Side 1
<p>1 <input id=WH_LENGTH1 type=text readonly>
<p>2 <input id=WH_LENGTH2 type=text readonly>
<hr>
<p>Side 2
<p>3 <input id=WH_LENGTH3 type=text readonly>
<p>4 <input id=WH_LENGTH4 type=text readonly>
</div><!--//end WH_lengths -->

<div id=CONSOLE></div>
</div><!--//end WH_CONTAINER -->
</body>




<script>(function(){
/******************************************************************************/
var D = document;
function E(id) { return document.getElementById(id); }

var MAX = {'NR':66, 'NF1':66, 'NF2':66 } //At these values, it starts to takes to long to run.
var PRIOR_FOCUS = "WH_ERD"; //Used to return focus to input that had error.
var PRIOR_VALUE = ""; //Used to revert to prior good value on error.

//Consider all raw size & x/y values to be mm,
//to coorespond directly to rim, hub, & spoke measurements.
var DEFAULTS = {'':0,
	'ERD' :577,  // Effective Rim Diameter
	'NR'  :24, 	 // Number of holes in the Rim
	'NF1' :8, 	 // Number of holes in Flange1
	'NF2' :16, 	 // 				   Flange2
	'PCD1':38.5, // Pitch Circle Diameter 1
	'PCD2':50.6, // 					  2
	'FTC1':37.7, // Flanget-to-Center 1 distance
	'FTC2':17.1, // 				  2
	'SX1' :0,    // Spoke Crossing 1
	'SX2' :3, 	 // 			   2
	'SHD' :2.6,  // Spoke Hole Diameter. Affects spoke length calcs only.
	'LACE_OPT':0,// Lace Option / Wheel Type
	'SG1':1,	 // Show spoke group 1  These are mostly for trouble shooting.
	'SG2':1,	 // Show spoke group 2 			"				"			
	'SG3':1, 	 // Show spoke group 3 			"				"			
	'SG4':1, 	 // Show spoke group 4 			"				"			
	'SD' :2,     // Spoke Diameter/Size. Affects display of spokes only, not calcs.
	'SHOW_R' :1, // Rim.  SGx (above) & 'SHOW_xxx values can be true/false or 1/0
	'SHOW_F1':1, // Flange 1
	'SHOW_F2':1, // Flange 2
	'COLOR1': '#44F', // SG1 Spoke Group 1
	'COLOR2': '#77D', // SG2 			 2
	'COLOR3': '#2B2', // SG3 			 3
	'COLOR4': '#6D6', // SG4 			 4
	'COLOR_R' : '#777', // Rim
	'COLOR_F1': '#AAA', // Flange 1
	'COLOR_F2': '#777', // Flange 2
	'COLOR_AXES': '#999',
	'SHOW_AXES': 1, // true/false or 1/0
	'HOLESIZE' : 4  // Affects displayed size only.
	};


//##### ##########################
/*************************************************./
var DEFAULTS = {'':0, 
	'ERD' :0,  // Effective Rim Diameter
	'NR'  :1, 	 // Number of holes in the Rim
	'NF1' :1, 	 // Number of holes in Flange1
	'NF2' :1, 	 // 				   Flange2
	'PCD1':0, // Pitch Circle Diameter 1
	'PCD2':0, // 					  2
	'FTC1':0, // Flanget-to-Center 1 distance
	'FTC2':0, // 				  2
	'SX1' :0,    // Spoke Crossing 1
	'SX2' :0, 	 // 			   2
	'SHD' :0,  // Spoke Hole Diameter. Affects spoke length calcs only.
	'LACE_OPT':0,// Lace Option / Wheel Type
	'SG1':1,	 // Show spoke group 1  These are mostly for trouble shooting.
	'SG2':1,	 // Show spoke group 2 			"				"			
	'SG3':1, 	 // Show spoke group 3 			"				"			
	'SG4':1, 	 // Show spoke group 4 			"				"			
	'SD' :2,     // Spoke Diameter/Size. Affects display of spokes only, not calcs.
	'SHOW_R' :1, // Rim.  SGx (above) & 'SHOW_xxx values can be true/false or 1/0
	'SHOW_F1':1, // Flange 1
	'SHOW_F2':1, // Flange 2
	'COLOR1': '#44F', // SG1 Spoke Group 1
	'COLOR2': '#77D', // SG2 			 2
	'COLOR3': '#2B2', // SG3 			 3
	'COLOR4': '#6D6', // SG4 			 4
	'COLOR_R' : '#777', // Rim
	'COLOR_F1': '#AAA', // Flange 1
	'COLOR_F2': '#777', // Flange 2
	'COLOR_AXES': '#999',
	'SHOW_AXES': 1, // true/false or 1/0
	'HOLESIZE' : 4  // Affects displayed size only.
	};
/*************************************************/


//##### ###########################################################################
function Log(something, esc, br) {
	if (typeof something === 'undefined') {
		E('CONSOLE').innerHTML = ""
		E('CONSOLE').style['display'] = "none";
		return;
	}

	if (esc == true) { something = escape_HTML(something + "") }
	
	if (br == true) { br = "<br>" } else { br = "" }
	
	E('CONSOLE').innerHTML += something + br;
	E('CONSOLE').scrollTop = E('CONSOLE').scrollHeight;
	E('CONSOLE').style['display'] = "inline-block";
}//end Log()
//##### ###########################################################################




//##### ###########################################################################
function escape_HTML(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };

  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}//end escape_HTML()
//##### ###########################################################################




function scroll_blur(event){
	//Permit "clearing" focus, and some keyboard navigation while in <input>'s.

	//Normalize the event & which/key/charcode...
	if (!event) {var event = window.event;} //for IE
	var event_code = event.which || event.keyCode || event.charCode;
	
	var ESC = 27, AU = 38, AD = 40, PU = 33, PD = 34;

	//remove focus from input/select to allow keyboard arrows/pageup/pagedown/etc page scrolling.
	if (event_code == ESC) { D.activeElement.blur(); return; }

	if (event.target.tagName == "INPUT") {
		//Arrow down scrolls the page up, towards the bottom of the page, and vice-versa.
		if      (event_code == AU) { window.scrollBy(0, -38); }
		else if (event_code == AD) { window.scrollBy(0,  38); }
		else if (event_code == PU) { window.scrollBy(0,-400); }
		else if (event_code == PD) { window.scrollBy(0, 400); }
	}
}//end scroll_blur()





function Create_Spoke_Holes(group, id, class1, class2, N, scale, shd, offset) { //***/
	//Create & position N spoke holes in <g id=group>, with radius of shd/2 (shd="spoke hole diameter")
	if (typeof offset == "undefined") { offset = 0 }

	var A = 360/N; //angle between holes
	
	var a = offset;	//angle to current hole from 0
	var cx, cy;		//coordinates for hole

	var odd = true;		//for alternating classes

	for (var sh = 1; sh <= N; sh++) {
		var full_id = id + '_' + sh;
		odd = !odd;
		if (odd) { var class_X = class1 } else { var class_X = class2 }
		E(group).innerHTML += '<circle id=' + full_id + ' class="' + class_X + '" r="' + (shd/2) + '" cx="0" cy="0" />';

		cx = Math.round(Math.sin( (a/180) * Math.PI) * scale * 10000)/10000;
		cy = Math.round(Math.cos( (a/180) * Math.PI) * scale * 10000)/10000;
		
		E(full_id).setAttribute('cx', cx);
		E(full_id).setAttribute('cy', cy);
		
		a += A; //Spoke hole 1 is first hole at or after 0 degrees/"6 o'clock".
	}

	E(id + "_1").style["fill"]	 = "red"; //Spoke 1
	E(id + "_1").style["stroke"] = "red"; //  "
	
}//end Create_Spoke_Holes() //*************************************************/




function Calc_Spoke_Lengths(flange, spoke_id) { //*********/
	//Calculate & display final spoke length.
	
	//Get spoke ends
	var x1 = E(spoke_id).getAttribute('x1');
	var y1 = E(spoke_id).getAttribute('y1');
	var x2 = E(spoke_id).getAttribute('x2');
	var y2 = E(spoke_id).getAttribute('y2');
	
	var dx = x2 - x1;
	var dy = y2 - y1;

	var ftc = E('FTC' + flange).value; //Add in Flange to Center...
	var S = Math.sqrt(dx*dx + dy*dy + ftc*ftc) - E('SHD').value/2;

	return Math.round(S * 10)/10;
}//end Calc_Spoke_Lengths() //*************************************************/




function Draw_Spoke(group, flange, flange_hole, rim_hole, color) { //**********/

	if (typeof color == "undefined") { color = "black" }

	var g_id = "WH_spokes"; // <g id="WH_spokes"> ...all spokes... </g>
	var flange_hole_id = "WH_f" + flange + "sh_" + flange_hole;
	var rim_hole_id	= "WH_rsh_" + rim_hole;

	var x1 = E(flange_hole_id).getAttribute('cx');
	var y1 = E(flange_hole_id).getAttribute('cy');
	var x2 = E(rim_hole_id).getAttribute('cx');
	var y2 = E(rim_hole_id).getAttribute('cy');

	var spoke_id = "WH_spoke_" + flange + "_" + flange_hole;
	var classes = 'WH_spoke WH_group' + group; //ex: 'WH_spoke WH_group1'
	var coords = ' x1="' + x1 +  '" y1="' + y1 +  '" x2="' + x2 +  '" y2="' + y2 +  '" ';
	var style = ' style="stroke:'+color+'"';

	var spoke = '<line id="' + spoke_id + '" class="' + classes+ '" ' + coords + style + '/>' + "\n";
	E(g_id).innerHTML += spoke;
	
	//Calculate & display final spoke length.
	if ((flange_hole == 1) || (flange_hole == 2)) {
		E('WH_LENGTH' + group).value = Calc_Spoke_Lengths(flange, spoke_id);
	}
}//end Draw_Spoke() //*********************************************************/




function Lacing_Option(f) { //*************************************************/
	/*************************************************************************./
	tl;dr: "It's complicated..."  :)

    In a triplet wheel, with a given spoke count & cross, there are two lace patterns possible: "Type 1" and "Type 2"  :)
    In this program, it is presented as "Lacing Option".  Also, it only concerns the side with more spokes (ex: the 16
	spoke side of an 8:16 triplet). 
    Well, those three options: spoke count, spoke cross, and lace type;  presents us with a three body quatum gravitational
    paradoxical muonicly generational relativistic anti-matter equatorial teseract that cost me many hours of time & much 
    pounding of my head against a cinder block wall...

    Anyway, to determine the matching rim hole for a given flange hole, a modifier is needed, either 1 or -1, depending on
	the desired triplet type & other two conditions. But, it's not always the same. And sometimes it's different, except 
	when it's not...

    All 8 possible combinations (3 "bits": count, cross, type) are summerized in each of the two tables below. 
    The first was created by experimentation of all 8 combination of inputs.  The second is just a translation, but it 
	contains the conditions actually used in the if/then below.
    
        T1   |    T2            1   |   -1               NR: Number of holes in the Rim (24, 27, 32, etc.)
     --------+--------      --------+--------            SX: Spoke Cross (1x, 2x, 3x, etc.)
     NR SX * | NR SX *      NR SX T | NR SX T            * : Modifier (1 or -1)
     --------+--------      --------+--------            T : Triplet Type (T1 or T2)
     E  E  1 | E  E -1      E  E  1 | E  O  1        
     O  E  1 | O  E -1      O  E  1 | O  O  1     \ | /    | | |
     E  O -1 | E  O  1      E  O  2 | E  E  2      \|/     | | |   (The "middle spoke" is on the opposite flange.          )
     0  O -1 | 0  O  1      O  O  2 | O  E  2       X      | | |   (Note: if you "hide" the opposite spokes in the program,)
                                                   /|\     | | |   (the pattern is actually opposite of these examples.    )
                                                  Type 1   Type 2  (So don't do that. :)                                   )
    
    Now, in basic spoke calc math, it's much simpler, because all that matters is spoke cross - we don't care about the voodoo
	involved in determining matching spoke holes in space.  But here, holes matter. And space.  And time.  I think. I guess.  
	Maybe. I don't know.  But it works now!  :)
    /*************************************************************************/


	var NRE = (E('NR'    ).value/2 == Math.round(E('NR'    ).value/2));  // Even number of rim holes?
	var SXE = (E('SX' + f).value/2 == Math.round(E('SX' + f).value/2));  // Even Spoke cross?
	var T1  = (E('LACE_OPT').selectedIndex == 0);						 // Triplet/Lacing Type 1?

	//#####Standard lacings...
	//#####if (E('NF1').value == E('NF2').value) { return 1 }

	if ( (NRE && SXE && T1) || (!NRE && SXE && T1) || (NRE && !SXE && !T1) || (!NRE && !SXE && !T1) )
		 { return  1 } 
	else { return -1 }
}//end Lacing_Option() //******************************************************/




function Create_Spoke_Groups(g1, g2, nr, nf, sx, f, color ) { //************/
	sx = Math.floor(sx);

	var gn = g1; //Used to toggle between g1 & g2
	var d  = 1;   //Direction. ie: leading or trailing spokes.

	var r_skip = nr/nf; //Normally 2, but can be 3 (flange 1), then 3/2 (flange 2) for triplets.

	//Flange 1 hole 1 gets rim hole 1.  Flange 2 hole 1 gets rim hole 2 (generally)...
	if (f == 2) {var f_skip = r_skip/2} else {var f_skip = 0}

	for (var h_hole = 1; h_hole <= nf; h_hole += 1) {
		
		var r_hole = (h_hole-1 + sx*d*Lacing_Option(f)) * r_skip + 1 + f_skip
		r_hole = Math.round(r_hole) //I don't like needing this, but can't figure out another way...
		
		if (r_hole > nr) {r_hole -= nr;}
		if (r_hole <  1) {r_hole += nr;}
		
		Draw_Spoke(gn,  f,  h_hole,  r_hole ,  color[gn]);
		if (gn == g2) { var gn = g1 } else { var gn = g2 }
		
		d = -d; //toggle direction, aka leading/trailing spokes.
	}


	Set_Style_by_Class('WH_group' + g1, "stroke-width", E('WH_SD').value);
	Set_Style_by_Class('WH_group' + g2, "stroke-width", E('WH_SD').value);
}//end Create_Spoke_Groups() //*************************************************/




function Setup_Wheel(ERD, NR, NF1, NF2, PCD1, PCD2, SX1, SX2, SHD, desc, spoke_colors) { /****/
	//While most of this function's parameters could be removed in lieu of accessing <input> values
	//directly, parameter names are shorter and makes for cleaner reading in the code below.

	Clear_Wheel();

	var NF = [0, NF1, NF2];
	var SX = [0, SX1, SX2];

	var AF = 360/NF2; //Angle between holes in Flange
	var offset_f1_f2 = AF/2; //Offset angle between left & right hub flange holes. The radial side is "0".
							 //##### Issue if triplet entered as 16:8 instead of 8:16...
							 
	var rotate = 180; //180 rotates wheel so that "spoke 1" is at 12 o'clock.

	//Draw & color rim & flange circles..
	E('WH_ERD') .setAttribute('r', ERD/2); //ERD & PCD's are "D"iameters, but SVG <circle>'s require radii...
	E('WH_PCD1').setAttribute('r', PCD1/2);//
	E('WH_PCD2').setAttribute('r', PCD2/2);//
	E('WH_ERD') .style['stroke'] = E('WH_COLOR_R').value;
	E('WH_PCD1').style['stroke'] = E('WH_COLOR_F1').value;
	E('WH_PCD2').style['stroke'] = E('WH_COLOR_F2').value;


	Create_Spoke_Holes('WH_rim_holes', 'WH_rsh' , 'WH_rsh', 'WH_rsh', NR , ERD/2 , SHD, 0);
	Create_Spoke_Holes('WH_flange_1' , 'WH_f1sh', 'WH_hsh', 'WH_hsh', NF1, PCD1/2, SHD, 0);
	Create_Spoke_Holes('WH_flange_2' , 'WH_f2sh', 'WH_hsh', 'WH_hsh', NF2, PCD2/2, SHD, offset_f1_f2);


	var f = 1; //flange
	Create_Spoke_Groups(1, 2, NR, NF[f], SX[f], f, spoke_colors)

	var f = 2; //flange
	Create_Spoke_Groups(3, 4, NR, NF[f], SX[f], f, spoke_colors)


	Show_Hide_Class('WH_group1', E('WH_SHOW1').checked); //Spokes are destroyed & re-created
	Show_Hide_Class('WH_group2', E('WH_SHOW2').checked); // onchange of most settings.
	Show_Hide_Class('WH_group3', E('WH_SHOW3').checked); //So, re-set their display state.
	Show_Hide_Class('WH_group4', E('WH_SHOW4').checked); //


	var view_W = 610; //Width
	var view_H = 610; //Height
	var V_offset = (-view_H/2); //Vertical Offset
	E('WH_box').setAttribute('width',  view_W);
	E('WH_box').setAttribute('height', view_H);
	E('WH_box').setAttribute('viewBox', (-view_W/2) + " " + V_offset + " " + view_W + " " + view_H);

	E('WH_wheel').setAttribute('transform', " rotate(" + rotate + ")");

	//##### Log(E('WH_The_SVG').innerHTML,1,1) //##### 
}//end Setup_Wheel() /*********************************************************/




function Clear_Wheel() { //****************************************************/
		E('WH_rim_holes').innerHTML = "";
		E('WH_flange_1') .innerHTML = "";
		E('WH_flange_2') .innerHTML = "";
		E('WH_spokes')   .innerHTML = "";
}//end Clear_Wheel() //********************************************************/




function ERROR_NOTICE(what) {//************************************************/
	//what = id of input field that has error/out of range value.
	PRIOR_FOCUS = what; //So WH_CLOSE_MSG button can return focus to that input.
	var msg = '"' + E(what).value + '" invalid.<br>'
	if ((what == 'NR') || (what == 'NF1') || (what == 'NF2')) {
		msg += " Valid range for NR & NF's:<br>1 to " + MAX[what] + ". ";
	}
	E('WH_MESSEGE').innerHTML = msg;
	E('WH_MSG_BOX').style['visibility'] = "visible";
	E(what).value = PRIOR_VALUE; //Prior to change...
	E('WH_CLOSE_MSG').focus();
}//end ERROR_NOTICE() //*******************************************************/




function Validate_Setting(input) { //*******************************************/

	//Check if "cleaned" value (after parseint & floor from onchange events) has really changed.
	if (input && (input.value == PRIOR_VALUE)) { return false }

	//A few basic checks
	if ((input.id == 'NR') || (input.id == 'NF1') || (input.id == 'NF2')) {
		if ((input.value < 1) || (input.value > MAX[input.id]) || isNaN(parseInt(input.value))	)
		{
			ERROR_NOTICE(input.id);
			return false;
		}
	} else if ((input.id == 'SX1') || (input.id == 'SX2')) {
		var f = input.id.substring(2); //get flange (1 or 2)
		//Long past practical, and the point things repeat or logically break...
		if (input.value*1 > E("NF" + f).value*1) {
			ERROR_NOTICE(input.id);
			return false;
		}
	}


	if (isNaN(input.value)) {
		ERROR_NOTICE(input.id);
		return false;
	}


	return true;
}//end Validate_Setting() //***************************************************/




function Build_Wheel(input) { //***********************************************/

	var Spoke_Colors	= ["", E('WH_COLOR1').value, E('WH_COLOR2').value,  E('WH_COLOR3').value, E('WH_COLOR4').value ];

	//Check if "cleaned" value (after parseint & floor from onchange events) has really changed.
	if (input && input.value == PRIOR_VALUE) { return }
	
	if ( input ) { if (!Validate_Setting(input)) { return } }
	

  //Setup_Wheel(ERD, NR, NF1, NF2, PCD1, PCD2, SX1, SX2, SHD, desc, Spoke_Colors)
	Setup_Wheel(
		E('ERD').value*1, E('NR').value*1, E('NF1').value*1, E('NF2').value*1,
		E('PCD1').value*1, E('PCD2').value*1, E('SX1').value*1, E('SX2').value*1,
		E('WH_HOLESIZE').value*1, "Not used?", Spoke_Colors
	);
}//end Build_Wheel() //********************************************************/




function Show_Hide_Class(classname, show) { //*********************************/
	var items = D.getElementsByClassName(classname);

	for (var s = 0; s < items.length; s++)
	{
		if (show) { items[s].style['display'] = "" ;   }
		else 	  { items[s].style['display'] = "none" }
	}
}//end Show_Hide_Class() //****************************************************/




function Show_Hide(id, show) { //**********************************************/
	if (show) { E(id).style['display'] = ""     }
	else 	  { E(id).style['display'] = "none" }
}//end Show_Hide() //**********************************************************/




function Set_Style_by_Class(classname, style, value) { //**********************/
	var objects = D.getElementsByClassName(classname);
	for (var s = 0; s < objects.length; s++) { objects[s].style[style] = value; }
}//end Set_Style_by_Class() //*************************************************/




function Set_Attribute_by_Class(classname, attribute, value) { //**************/
	var objects = D.getElementsByClassName( classname );
	for (var x = 0; x < objects.length; x++) { objects[x].setAttribute( attribute, value ); }
}//end Set_Style_by_Class() //*************************************************/




function Assign_Input_Events() { //********************************************/

	//Save prior value in case of error in new value.
	var settings = ['ERD','NR','NF1','NF2','PCD1','PCD2','FTC1','FTC2','SX1','SX2','SHD'];
	for (var x = 0; x <settings.length; x++) {
		E(settings[x]).onfocus = function() { PRIOR_VALUE = this.value }
	}


	E('ERD') .onchange = function() { this.value = Math.abs(Math.floor(parseInt(this.value))); Build_Wheel(this) }
	E('NR')	 .onchange = function() { this.value = Math.abs(Math.floor(parseInt(this.value))); Build_Wheel(this) }
	E('NF1') .onchange = function() { this.value = Math.abs(Math.floor(parseInt(this.value))); Build_Wheel(this) }
	E('NF2') .onchange = function() { this.value = Math.abs(Math.floor(parseInt(this.value))); Build_Wheel(this) }
	E('PCD1').onchange = function() { this.value = Math.abs(parseFloat(this.value)); Build_Wheel(this) }
	E('PCD2').onchange = function() { this.value = Math.abs(parseFloat(this.value)); Build_Wheel(this) }
	E('FTC1').onchange = function() { this.value = Math.abs(parseFloat(this.value)); Build_Wheel(this) }
	E('FTC2').onchange = function() { this.value = Math.abs(parseFloat(this.value)); Build_Wheel(this) }
	E('SX1') .onchange = function() { this.value = Math.abs(Math.floor(this.value)); Build_Wheel(this) }
	E('SX2') .onchange = function() { this.value = Math.abs(Math.floor(this.value)); Build_Wheel(this) }

	// Only need to recalc final spoke lengths. SHD is ignored in display calculations for <line>'s
	E('SHD').onchange = function() { 
		this.value = Math.abs(parseFloat(this.value));
		if (!Validate_Setting(this)) { return }
		E('WH_LENGTH1').value = Calc_Spoke_Lengths(1, 'WH_spoke_1_1'); //WH_spoke_(flange)_(hole)
		E('WH_LENGTH2').value = Calc_Spoke_Lengths(1, 'WH_spoke_1_2');
		E('WH_LENGTH3').value = Calc_Spoke_Lengths(2, 'WH_spoke_2_1');
		E('WH_LENGTH4').value = Calc_Spoke_Lengths(2, 'WH_spoke_2_2');
	}


	E('LACE_OPT') .onchange = function() { Build_Wheel() }

	E('WH_COLOR1').onchange = function() { Set_Style_by_Class('WH_group1', "stroke", this.value) }
	E('WH_COLOR2').onchange = function() { Set_Style_by_Class('WH_group2', "stroke", this.value) }
	E('WH_COLOR3').onchange = function() { Set_Style_by_Class('WH_group3', "stroke", this.value) }
	E('WH_COLOR4').onchange = function() { Set_Style_by_Class('WH_group4', "stroke", this.value) }
	E('WH_SHOW1') .onchange = function() { Show_Hide_Class('WH_group1', this.checked) }
	E('WH_SHOW2') .onchange = function() { Show_Hide_Class('WH_group2', this.checked) }
	E('WH_SHOW3') .onchange = function() { Show_Hide_Class('WH_group3', this.checked) }
	E('WH_SHOW4') .onchange = function() { Show_Hide_Class('WH_group4', this.checked) }
	
	E('WH_SD') .onchange = function() { //Spoke Diameter, or Size. Affects display of spokes only (not calcs).
		for (var group=1; group <= 4; group++) {
			Set_Style_by_Class('WH_group' + group , "stroke-width", this.value);
		}
	}

	E('WH_COLOR_R') .onchange = function() { E('WH_ERD') .style['stroke'] = this.value }
	E('WH_COLOR_F1').onchange = function() { E('WH_PCD1').style['stroke'] = this.value }
	E('WH_COLOR_F2').onchange = function() { E('WH_PCD2').style['stroke'] = this.value }
	E('WH_SHOW_R')  .onchange = function() { Show_Hide('WH_ERD',  this.checked) }
	E('WH_SHOW_F1') .onchange = function() { Show_Hide('WH_PCD1', this.checked) }
	E('WH_SHOW_F2') .onchange = function() { Show_Hide('WH_PCD2', this.checked) }

	E('WH_COLOR_AXES').onchange = function() { Set_Style_by_Class('WH_axis', "stroke", this.value) }
	E('WH_SHOW_AXES').onchange = function() { Show_Hide_Class('WH_axis', this.checked); }

	E('WH_HOLESIZE') .onchange = function() {
		//set *radius* of holes (this.value/2)
		Set_Attribute_by_Class('WH_rsh', 'r', this.value/2)
		Set_Attribute_by_Class('WH_hsh', 'r', this.value/2)
	}

	//Assign both onblur & onclick same function...
	E('WH_CLOSE_MSG').onblur  =
	E('WH_CLOSE_MSG').onclick = function() {
		E('WH_MSG_BOX').style['visibility'] = "hidden";
		E('WH_MESSEGE').innerHTML = "";
		E(PRIOR_FOCUS).focus();
	}

}//end Assign_Input_Events() //************************************************/




function WH_Init() { //********************************************************/
	//Load default values.
	E('ERD') .value = DEFAULTS['ERD'];
	E('NR')  .value = DEFAULTS['NR'];
	E('NF1') .value = DEFAULTS['NF1'];
	E('NF2') .value = DEFAULTS['NF2'];
	E('PCD1').value = DEFAULTS['PCD1'];
	E('PCD2').value = DEFAULTS['PCD2'];
	E('FTC1').value = DEFAULTS['FTC1'];
	E('FTC2').value = DEFAULTS['FTC2'];
	E('SX1') .value = DEFAULTS['SX1'];
	E('SX2') .value = DEFAULTS['SX2'];
	E('SHD') .value = DEFAULTS['SHD']; //Affects spoke length calcs only.
	E('LACE_OPT').selectedIndex = DEFAULTS['LACE_OPT'];	 //The index (0 or 1) is used in Lacing_Option().
	
	E('WH_COLOR1').value   = DEFAULTS['COLOR1'];
	E('WH_COLOR2').value   = DEFAULTS['COLOR2'];
	E('WH_COLOR3').value   = DEFAULTS['COLOR3'];
	E('WH_COLOR4').value   = DEFAULTS['COLOR4'];
	E('WH_SHOW1') .checked = DEFAULTS['SG1'];
	E('WH_SHOW2') .checked = DEFAULTS['SG2'];
	E('WH_SHOW3') .checked = DEFAULTS['SG3'];
	E('WH_SHOW4') .checked = DEFAULTS['SG4'];
	E('WH_SD')    .value   = DEFAULTS['SD']; //Spoke Diameter, or Size. Affects display of spokes only (not calcs).

	E('WH_COLOR_R') .value   = DEFAULTS['COLOR_R'];
	E('WH_COLOR_F1').value   = DEFAULTS['COLOR_F1'];
	E('WH_COLOR_F2').value   = DEFAULTS['COLOR_F2'];
	E('WH_SHOW_R')  .checked = DEFAULTS['SHOW_R'];
	E('WH_SHOW_F1') .checked = DEFAULTS['SHOW_F1'];
	E('WH_SHOW_F2') .checked = DEFAULTS['SHOW_F2'];

	E('WH_COLOR_AXES').value   = DEFAULTS['COLOR_AXES'];
	E('WH_SHOW_AXES') .checked = DEFAULTS['SHOW_AXES'];
	E('WH_HOLESIZE')  .value   = DEFAULTS['HOLESIZE']; //Affects displed size only.

	E('LACE_OPT').options[0].value = 1;  //The option values (1 or -1) are used in the 
	E('LACE_OPT').options[1].value = -1; // spoke length calculations. DO NOT CHANGE 
	//end Loading default values


	Assign_Input_Events();

	Build_Wheel();

	E('ERD').focus();
}//end WH_Init() //************************************************************/


window.addEventListener("keydown", function(event) {scroll_blur(event)} );
window.addEventListener("load", function(){WH_Init()} );
//*****************************************************************************/
})();</script>
